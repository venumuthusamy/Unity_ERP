<div class="content-wrapper p-0">
  <div class="content-body">
    <section class="users-list-wrapper">
      <div class="card">

        <div class="row">
          <div class="col-md-3 col-12">
            <h4 class="card-text"
                style="margin-left:0.85rem;margin-top:1rem;font-size:1.25rem;font-weight:600;color:#2E5F73;">
              Production Plan List
            </h4>
          </div>

          <div class="col-md-9 col-12 d-flex justify-content-end">
            <div class="d-flex align-items-center pr-1 pb-1 pb-md-0 mt-1" style="gap:10px;">
              <label class="d-flex align-items-center">
                Search:
                <input class="form-control ml-25" type="search" [(ngModel)]="searchValue"
                       (keyup)="applyFilter()" (search)="applyFilter()">
              </label>

              <button class="btn d-inline-flex align-items-center"
                      style="background:#2E5F73;color:#fff;gap:6px;" (click)="goToCreate()"
                      >
                <i data-feather="plus-circle"></i>
                <span>Create From SO</span>
              </button>
            </div>
          </div>
        </div>

        <ngx-datatable class="bootstrap core-bootstrap"
          [rows]="rows"
          [rowHeight]="50"
          [headerHeight]="50"
          [footerHeight]="50"
          [limit]="10"
          [columnMode]="'force'">

          <!-- view explosion -->
          <ngx-datatable-column [width]="50" [sortable]="false">
            <ng-template ngx-datatable-cell-template let-row="row">
              <span (click)="openExplosion(row)" title="Explosion"
                    style="cursor:pointer;font-size:18px;color:#2E5F73;">
                <i class="fas fa-eye"></i>
              </span>
            </ng-template>
          </ngx-datatable-column>

          <ngx-datatable-column name="Plan ID" prop="id" [width]="100"></ngx-datatable-column>
          <ngx-datatable-column name="SO NO" prop="salesOrderNo" [width]="160"></ngx-datatable-column>

          <ngx-datatable-column name="Plan Date" prop="planDate" [width]="140">
            <ng-template ngx-datatable-cell-template let-row="row">
              {{ row.planDate | date:'dd-MM-yyyy' }}
            </ng-template>
          </ngx-datatable-column>

          <ngx-datatable-column name="Status" prop="status" [width]="120"></ngx-datatable-column>

          <ngx-datatable-column name="Shortage" prop="totalShortage" [width]="140">
            <ng-template ngx-datatable-cell-template let-row="row">
              <span class="badge badge-pill"
                    [ngClass]="row.totalShortage > 0 ? 'badge-danger' : 'badge-success'">
                {{ row.totalShortage | number:'1.0-2' }}
              </span>
            </ng-template>
          </ngx-datatable-column>

          <ngx-datatable-column name="Action" [width]="160">
            <ng-template ngx-datatable-cell-template let-row="row">
              <div style="display:flex;justify-content:center;gap:12px;align-items:center;">
                <!-- Edit icon -->
                <i class="fas fa-pen text-primary"
                   style="cursor:pointer;"
                   (click)="edit(row.id)"
                   title="Edit"></i>

                <!-- Delete icon -->
                <i class="fas fa-trash text-danger"
                   style="cursor:pointer;"
                   (click)="remove(row.id)"
                   title="Delete"></i>
              </div>
            </ng-template>
          </ngx-datatable-column>

        </ngx-datatable>
      </div>
    </section>
  </div>
</div>

<!-- Lines Modal -->
<div *ngIf="showExplosionModal" (click)="closeExplosion()"
     style="position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1050;display:flex;align-items:center;justify-content:center;">
  <div (click)="$event.stopPropagation()"
       style="width:900px;max-width:95vw;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.25);">

    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #eef2f7;">
      <h3 style="margin:0;font-size:20px;font-weight:600;color:#374151;">{{ modalTitle || 'Plan Lines' }}</h3>
      <button (click)="closeExplosion()"
              style="border:0;background:transparent;font-size:22px;cursor:pointer;color:#6b7280;">Ã—</button>
    </div>

    <div style="padding:16px 20px;">
      <div style="max-height:60vh;overflow:auto;border:1px solid #eef2f7;border-radius:10px;">
        <table style="width:100%;border-collapse:collapse;font-size:14px;color:#111827;">
          <thead>
            <tr style="background:#2E5F73;color:#fff;">
              <th style="padding:10px 12px;text-align:left;width:60px;">#</th>
              <th style="padding:10px 12px;text-align:left;">Finished Item</th>
              <th style="padding:10px 12px;text-align:right;width:140px;">Planned Qty</th>
              <th style="padding:10px 12px;text-align:right;width:160px;">Expected Output</th>
              <th style="padding:10px 12px;text-align:right;width:110px;">RecipeId</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let l of planLines; let i=index"
                [style.background]="i%2===0 ? '#fcfdff' : '#ffffff'"
                style="border-bottom:1px solid #f1f5f9;">
              <td style="padding:10px 12px;">{{ i + 1 }}</td>
              <td style="padding:10px 12px;">
                {{ l.finishedItemName || ('ItemId: ' + l.finishedItemId) }}
              </td>
              <td style="padding:10px 12px;text-align:right;">{{ l.plannedQty | number:'1.0-2' }}</td>
              <td style="padding:10px 12px;text-align:right;">{{ l.expectedOutput | number:'1.0-2' }}</td>
              <td style="padding:10px 12px;text-align:right;">{{ l.recipeId }}</td>
            </tr>

            <tr *ngIf="!planLines?.length">
              <td colspan="5" style="padding:14px 12px;text-align:center;color:#6b7280;">No lines</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;padding:12px 20px;border-top:1px solid #eef2f7;">
      <button (click)="closeExplosion()"
              style="background:#2E5F73;color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer;">
        Close
      </button>
    </div>

  </div>
</div>

