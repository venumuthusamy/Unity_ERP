<div class="content-wrapper p-0">
  <div class="content-body">
    <section class="users-list-wrapper">
      <div class="card">

        <!-- ==================== HEADER ROW ==================== -->
        <div class="row">
          <!-- Title + page size -->
          <div class="col-md-3 col-12">
            <h4 class="card-text"
                style="margin-left:0.85rem;margin-top:0.75rem;font-size:1.25rem;font-weight:600;color:#2E5F73;">
              Recipe List
            </h4>

            <div class="d-flex justify-content-between align-items-center m-1">
              <label class="d-flex align-items-center">
                Show
                <select class="form-control mx-25" (change)="onLimitChange($event)">
                  <option [selected]="selectedOption===10" value="10">10</option>
                  <option [selected]="selectedOption===25" value="25">25</option>
                  <option [selected]="selectedOption===50" value="50">50</option>
                  <option [selected]="selectedOption===100" value="100">100</option>
                </select>
                entries
              </label>
            </div>
          </div>

          <!-- Search + Add -->
          <div class="col-md-9 col-12 d-flex justify-content-start justify-content-md-end">
            <div class="d-flex align-items-center justify-content-end pr-1 pb-1 pb-md-0">

              <!-- Search -->
              <label class="d-flex align-items-center ml-1 ml-md-0">
                Search:
                <input
                  [(ngModel)]="searchValue"
                  name="searchValue"
                  type="search"
                  class="form-control ml-25"
                  (keyup)="filterUpdate($event)"
                  (search)="filterUpdate($event)" />
              </label>

              <div class="d-flex align-items-center ml-1">
                <!-- Add -->
                <button
                  (click)="goToCreate()"
                  class="btn mr-1 d-inline-flex align-items-center"
                  style="background-color:#2E5F73;color:white;gap:6px;"
                  title="Create Recipe">
                  <i data-feather="plus-circle" class="w-4 h-4"></i>
                  <span>Add</span>
                </button>
              </div>

            </div>
          </div>
        </div>

        <!-- ==================== MAIN DATATABLE ==================== -->
        <ngx-datatable
          class="bootstrap core-bootstrap"
          [rows]="rows"
          [rowHeight]="50"
          [headerHeight]="50"
          [footerHeight]="50"
          [limit]="selectedOption"
          [columnMode]="'force'"
          [scrollbarH]="false"
          [reorderable]="true">

          <!-- View lines -->
          <ngx-datatable-column
            [width]="50"
            [resizeable]="false"
            [sortable]="false"
            [draggable]="false"
            [canAutoResize]="false">
            <ng-template ngx-datatable-cell-template let-row="row">
              <span
                (click)="openLinesModal(row)"
                title="View Ingredients"
                style="cursor:pointer;font-size:18px;color:#2E5F73;">
                <i class="fas fa-eye"></i>
              </span>
            </ng-template>
          </ngx-datatable-column>

          <!-- <ngx-datatable-column name="Code" prop="code" [width]="140"></ngx-datatable-column> -->
          <ngx-datatable-column name="Name" prop="finishedItemName" [width]="240"></ngx-datatable-column>

          <ngx-datatable-column name="Cuisine" prop="cuisine" [width]="170">
            <ng-template let-row="row" ngx-datatable-cell-template>
              {{ row.cuisine || '-' }}
            </ng-template>
          </ngx-datatable-column>

          <ngx-datatable-column name="Cost" prop="totalCost" [width]="140">
            <ng-template let-row="row" ngx-datatable-cell-template>
              <span style="font-weight:700;">
                {{ row.totalCost ?? 0 | number:'1.2-2' }}
              </span>
            </ng-template>
          </ngx-datatable-column>

          <ngx-datatable-column name="Status" prop="status" [width]="130">
            <ng-template let-row="row" ngx-datatable-cell-template>
              <div class="badge badge-pill status-pill"
                   [ngClass]="{
                     'badge-secondary': (row.status || '').toLowerCase() === 'draft',
                     'badge-success'  : (row.status || '').toLowerCase() === 'active',
                     'badge-warning'  : (row.status || '').toLowerCase() === 'inactive'
                   }">
                {{ row.status || 'Draft' }}
              </div>
            </ng-template>
          </ngx-datatable-column>

          <ngx-datatable-column name="Action" [width]="170">
            <ng-template let-row="row" ngx-datatable-cell-template>
              <div style="display:flex;justify-content:center;align-items:center;gap:10px;">

                <!-- Edit -->
                <i class="fas fa-pen text-primary"
                   style="cursor:pointer;"
                   (click)="editRecipe(row.id)"
                   title="Edit"></i>

                <!-- Delete -->
                <i class="fas fa-trash text-danger"
                   style="cursor:pointer;"
                   (click)="deleteRecipe(row.id)"
                   title="Delete"></i>

              </div>
            </ng-template>
          </ngx-datatable-column>

        </ngx-datatable>

      </div>
    </section>
  </div>
</div>

<!-- INGREDIENTS POPUP (same style as PR Lines popup) -->
<div
  *ngIf="showLinesModal"
  (click)="closeLinesModal()"
  style="position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1050;display:flex;align-items:center;justify-content:center;">

  <div
    (click)="$event.stopPropagation()"
    style="width:800px;max-width:95vw;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.25);">

    <!-- Header -->
    <div
      style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #eef2f7;">
      <h3 style="margin:0;font-size:20px;line-height:1.2;font-weight:700;color:#374151;">
        Ingredients
      </h3>

      <button
        (click)="closeLinesModal()"
        aria-label="Close"
        style="border:0;background:transparent;font-size:22px;line-height:1;cursor:pointer;color:#6b7280;">
        Ã—
      </button>
    </div>

    <!-- Body -->
    <div style="padding:16px 20px;">
      <div
        style="max-height:60vh;overflow:auto;border:1px solid #eef2f7;border-radius:10px;">

        <table style="width:100%;border-collapse:collapse;font-size:14px;color:#111827;">
          <thead>
            <tr style="background:#2E5F73;color:#fff;">
              <th style="padding:10px 12px;text-align:left;font-weight:600;">Ingredient</th>
              <th style="padding:10px 12px;text-align:right;font-weight:600;width:120px;">Qty</th>
              <th style="padding:10px 12px;text-align:left;font-weight:600;width:120px;">UOM</th>
              <th style="padding:10px 12px;text-align:right;font-weight:600;width:120px;">Yield %</th>
              <th style="padding:10px 12px;text-align:right;font-weight:600;width:140px;">Cost</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngIf="!selectedLines?.length">
              <td colspan="5" style="padding:14px 12px;text-align:center;color:#6b7280;">
                No lines
              </td>
            </tr>

            <tr
              *ngFor="let l of selectedLines; let i = index"
              [style.background]="i % 2 === 0 ? '#fcfdff' : '#ffffff'"
              style="border-bottom:1px solid #f1f5f9;">

              <td
                style="padding:10px 12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:420px;">
                {{ l.ingredientItemName || '-' }}
              </td>

              <td style="padding:10px 12px;text-align:right;font-variant-numeric:tabular-nums;">
                {{ l.qty || 0 }}
              </td>

              <td style="padding:10px 12px;">
                {{ l.uomName || l.uom || '-' }}
              </td>

              <td style="padding:10px 12px;text-align:right;font-variant-numeric:tabular-nums;">
                {{ l.yieldPct ?? 0 }}
              </td>

              <td style="padding:10px 12px;text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">
                {{ (l.rowCost ?? 0) | number:'1.2-2' }}
              </td>
            </tr>
          </tbody>

          <!-- Footer total (optional) -->
          <tfoot *ngIf="selectedLines?.length">
            <tr style="background:#f3f4f6;border-top:1px solid #e5e7eb;">
              <td colspan="4" style="padding:10px 12px;font-weight:700;">Total</td>
              <td style="padding:10px 12px;text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">
                {{ modalTotalQty }}
              </td>
            </tr>
          </tfoot>

        </table>
      </div>
    </div>

    <!-- Footer buttons -->
    <div
      style="display:flex;justify-content:flex-end;gap:8px;padding:12px 20px;border-top:1px solid #eef2f7;">
      <button
        (click)="closeLinesModal()"
        style="background:#2E5F73;color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer;">
        Close
      </button>
    </div>

  </div>
</div>

