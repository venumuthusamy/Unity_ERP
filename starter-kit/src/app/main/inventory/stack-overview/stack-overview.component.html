<button
  class="btn back-btn mb-2 position-relative d-flex align-items-center justify-content-center"
  (click)="goToStockOverviewList()">
  <i class="fas fa-arrow-left position-absolute back-ico" aria-hidden="true"></i>
  Stock Overview List
</button>

<div class="card card-elevated rounded-16">
  <div class="card-header d-flex align-items-center justify-content-between bg-white border-0">
    <div class="hdr-title">
      <div class="hdr-h">Stock Overview</div>
      <div class="hdr-sub">Material Requisition based transfer</div>
    </div>

    <button
      type="button"
      class="transfer-btn"
      [disabled]="!canTransfer()"
      (click)="submitTransfer()">
      <i class="fas fa-exchange-alt" aria-hidden="true"></i>
      Transfer
    </button>
  </div>

  <div class="card-body">

    <!-- ===================== OPTIONS ===================== -->
    <div class="options-card">
      <div class="options-title">Options</div>

      <div class="row g-3">
        <!-- Material Requisition -->
        <div class="col-12 col-md-4">
          <label class="form-label">Material Requisition</label>

          <ng-select
            [items]="mrList"
            bindLabel="display"
            bindValue="id"
            placeholder="Select MRQ"
            [(ngModel)]="selectedMrId"
            (ngModelChange)="onMrChanged($event)"
            class="w-100">
          </ng-select>

          <div class="hint" *ngIf="selectedMrId">
            Auto bind MRQ id: <b>{{ selectedMrId }}</b>
          </div>
        </div>

        <!-- Destination Outlet -->
        <div class="col-12 col-md-4">
          <label class="form-label">Destination Outlet (MR Outlet)</label>
          <input class="form-control"
                 [value]="destinationOutletName || ''"
                 readonly
                 placeholder="Auto from MRQ" />

          <div class="hint" *ngIf="destinationOutletId">
            Destination outlet excluded from From Outlet list.
          </div>
        </div>

        <!-- ✅ Destination Bin -->
        <div class="col-12 col-md-4">
          <label class="form-label">Destination Bin (MR Bin)</label>
          <input class="form-control"
                 [value]="destinationBinName || ''"
                 readonly
                 placeholder="Auto from MRQ" />

          <div class="hint" *ngIf="destinationBinId">
            Auto bind BinId: <b>{{ destinationBinId }}</b>
          </div>
        </div>

        <!-- From Outlet -->
        <div class="col-12 col-md-6">
          <label class="form-label">From Outlet</label>

          <ng-select
            [items]="fromOutletOptions"
            bindLabel="label"
            bindValue="id"
            [compareWith]="compareById"
            placeholder="Select From Outlet"
            [(ngModel)]="selectedFromOutletId"
            (ngModelChange)="onFromOutletChanged($event)"
            class="w-100">

            <ng-template ng-option-tmp let-item="item">
              <div class="opt-row">
                <div class="opt-name">{{ item.name }}</div>
                <div class="opt-meta">
                  Req <b>{{ item.reqQty }}</b>
                  <span class="sep">•</span>
                  OnHand <b>{{ item.onHand }}</b>
                </div>
              </div>
            </ng-template>

            <ng-template ng-label-tmp let-item="item">
              <span class="sel-name">{{ item.name }}</span>
              <span class="sel-meta">Req {{ item.reqQty }} • OnHand {{ item.onHand }}</span>
            </ng-template>
          </ng-select>

          <div class="hint">Transfer will use selected From Outlet.</div>
        </div>

        <!-- From Outlet Name preview -->
        <div class="col-12 col-md-6">
          <label class="form-label">Selected From Outlet</label>
          <input class="form-control"
                 [value]="selectedFromOutletName || ''"
                 readonly
                 placeholder="Select From Outlet" />
          <div class="hint">This outlet stock rows will be shown below.</div>
        </div>
      </div>

      <!-- SKU Card -->
      <div class="sku-card" *ngIf="selectedSku">
        <div class="sku-left">
          <div class="sku-code">{{ selectedSku }}</div>
          <div class="sku-name" *ngIf="selectedItemName">{{ selectedItemName }}</div>
        </div>

        <div class="sku-right">
          <div class="mini-chip">
            <span class="chip-k">Request Qty</span>
            <span class="chip-v">{{ requestedQty }}</span>
          </div>

          <div class="meta-line">
            Requester: <b>{{ requesterName || '-' }}</b>
            <span class="dot">•</span>
            Date: <b>{{ reqDate || '-' }}</b>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== Loading / Error ===================== -->
    <div *ngIf="loading" class="mt-2 small text-muted">Loading…</div>
    <div *ngIf="!loading && errorMsg" class="mt-2 text-danger small">{{ errorMsg }}</div>

    <!-- ===================== GRID ===================== -->
    <div class="grid-card mt-3">
      <div class="grid-head">
        <div class="grid-title">Stock in selected outlet</div>

        <div class="grid-sub" *ngIf="selectedFromOutletName">
          From Outlet: <b>{{ selectedFromOutletName }}</b>
        </div>
      </div>

      <div class="grid-table-wrap">
        <table class="grid-table">
          <thead>
            <tr>
              <th>Outlet</th>
              <th>Supplier</th>
              <th>Bin</th>
              <th class="text-end">On Hand</th>
              <th class="text-end">Available</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let r of filteredRows; trackBy: trackByRow">
              <td class="cell-strong">{{ r.warehouse }}</td>
              <td class="cell-muted">{{ r.supplierName || '-' }}</td>
              <td class="cell-muted">{{ r.bin }}</td>
              <td class="text-end cell-num">{{ r.onHand }}</td>
              <td class="text-end cell-num">{{ r.available }}</td>
            </tr>

            <tr *ngIf="!filteredRows?.length">
              <td colspan="5" class="empty-state">
                No rows found for selected SKU / outlet.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="grid-foot" *ngIf="filteredRows?.length">
        <span class="foot-pill">Showing {{ filteredRows.length }} row(s)</span>
      </div>
    </div>



  </div>
</div>
