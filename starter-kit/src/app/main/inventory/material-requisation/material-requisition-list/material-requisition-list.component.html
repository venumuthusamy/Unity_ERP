<div class="mrq-list-page mrq-compact">
  <!-- ===== Top Bar: Title left + Buttons right ===== -->
  <div class="mrq-topbar">
    <div class="mrq-topbar-left">
      <h4 class="mrq-title">Material Requisition List</h4>
      <!-- <div class="mrq-subtitle">Material Requisition list.</div> -->
    </div>

    <div class="mrq-topbar-right">
      <!-- ✅ MR List button removed -->

      <button class="mrq-top-btn" type="button" (click)="goStockOverview()">
        Stock Overview List
      </button>

      <button class="mrq-top-btn" type="button" (click)="goStockTransfer()">
        Stock Transfer List
      </button>

      <button class="mrq-btn-primary" (click)="goToCreateForm()">
        <span class="mrq-btn-ic"><i class="fas fa-plus"></i></span>
        <span>New Request</span>
      </button>
    </div>
  </div>

  <!-- ===== Main Card ===== -->
  <div class="mrq-card">
    <!-- Filters -->
    <div class="mrq-filters">
      <div class="mrq-show">
        <span>Show</span>
        <select class="form-control mrq-select" [(ngModel)]="pageSize">
          <option *ngFor="let s of pageSizes" [value]="s">{{ s }}</option>
        </select>
        <span>entries</span>
      </div>

      <div class="mrq-search">
        <span class="mrq-search-label">Search:</span>
        <input
          [(ngModel)]="searchValue"
          type="search"
          class="form-control mrq-search-input"
          (input)="applyFilter()"
          placeholder="Req No / Requester / Outlet" />
      </div>
    </div>

    <!-- Loading / Error -->
    <div *ngIf="loading" class="mrq-loading">Loading…</div>
    <div *ngIf="errorMsg" class="alert alert-danger mx-2 my-2">{{ errorMsg }}</div>

    <!-- Table -->
    <div class="mrq-table-shell">
      <ngx-datatable
        class="bootstrap core-bootstrap item-table"
        [rows]="filteredRows"
        [rowHeight]="56"
        [headerHeight]="48"
        [footerHeight]="48"
        [limit]="pageSize"
        [columnMode]="'force'"
        [scrollbarH]="false"
        [reorderable]="true"
        [rowIdentity]="rowIdentity"
        [trackByProp]="'gridKey'">

        <!-- REQ NO -->
        <ngx-datatable-column name="REQ NO" [width]="260">
          <ng-template let-row="row" ngx-datatable-cell-template>
            <div class="mrq-cell-flex">
              <button
                type="button"
                class="mrq-icon-btn"
                title="View"
                (click)="openViewModal(row, viewModal)">
                <i class="fas fa-eye"></i>
              </button>

              <span class="mrq-reqno">{{ row.reqNo || '-' }}</span>
            </div>
          </ng-template>
        </ngx-datatable-column>

        <!-- OUTLET -->
        <ngx-datatable-column name="OUTLET" [width]="220">
          <ng-template let-row="row" ngx-datatable-cell-template>
            {{ row.outletName ?? '-' }}
          </ng-template>
        </ngx-datatable-column>

        <!-- REQUESTER -->
        <ngx-datatable-column name="REQUESTER" prop="requesterName" [width]="190"></ngx-datatable-column>
       <!-- TOTAL QTY -->
        <ngx-datatable-column name="TOTAL QTY" [width]="185">
          <ng-template let-row="row" ngx-datatable-cell-template>
            {{ row.totalQty ?? 0 }}
          </ng-template>
        </ngx-datatable-column>
        <!-- REQ DATE -->
        <ngx-datatable-column name="REQ DATE" [width]="175">
          <ng-template let-row="row" ngx-datatable-cell-template>
            {{ row.reqDate ? (row.reqDate | date:'yyyy-MM-dd') : '-' }}
          </ng-template>
        </ngx-datatable-column>

 

        <!-- STATUS -->
    <ngx-datatable-column name="STATUS" [width]="220">
          <ng-template let-row="row" ngx-datatable-cell-template>
            <span class="mrq-status-pill" [ngClass]="{
              'is-pending': row.status === 1,
              'is-partial': row.status === 2,
              'is-full': row.status === 3,
              'is-done': row.status === 4
            }">
              {{ getStatusLabel(row.status) }}
            </span>
          </ng-template>
        </ngx-datatable-column>
        <!-- ACTION -->
       <ngx-datatable-column name="ACTION" [width]="140" [sortable]="false" [canAutoResize]="false">
  <ng-template ngx-datatable-cell-template let-row="row">
    <button
      type="button"
      class="mrq-icon-btn"
      title="Edit"
      (click)="row.status === 1 && editReq(row)"
      [disabled]="row.status !== 1"
      [ngClass]="{ 'is-disabled': row.status !== 1 }">
      <i class="fas fa-pen"></i>
    </button>
  </ng-template>
</ngx-datatable-column>

      </ngx-datatable>
    </div>

    <div class="mrq-total">{{ filteredRows?.length || 0 }} total</div>
  </div>
</div>

<!-- View Items Modal -->
<!-- View Items Modal -->
<ng-template #viewModal let-close="close" let-dismiss="dismiss">
  <div class="mrq-modal">
    <!-- Header -->
    <div class="mrq-modal-head">
      <div class="mrq-modal-titlewrap">
        <div class="mrq-modal-title">
          {{ selectedReq?.reqNo || 'Material Requisition' }}
        </div>

        <div class="mrq-modal-sub">
          <span class="mrq-kv">
            <span class="k">Outlet</span>
            <span class="v">{{ selectedReq?.outletName ?? '-' }}</span>
          </span>

          <span class="mrq-kv">
            <span class="k">Requester</span>
            <span class="v">{{ selectedReq?.requesterName ?? '-' }}</span>
          </span>

          <span class="mrq-kv">
            <span class="k">Date</span>
            <span class="v">{{ selectedReq?.reqDate ? (selectedReq?.reqDate | date:'yyyy-MM-dd') : '-' }}</span>
          </span>
        </div>
      </div>

      <div class="mrq-modal-actions">
        <!-- Status badge -->
        <span class="mrq-status-badge" [ngClass]="{
          'is-pending': selectedReq?.status === 1,
          'is-out': selectedReq?.status === 2,
          'is-done': selectedReq?.status === 3
        }">
          {{ getStatusLabel(selectedReq?.status) }}
        </span>

        <!-- top close -->
        <button type="button" class="mrq-xbtn" aria-label="Close" (click)="dismiss('x')">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Body -->
    <div class="mrq-modal-body">
      <div class="mrq-items-card">
        <div class="mrq-items-head">
          <div class="mrq-items-head-left">
            <i class="fas fa-box-open"></i>
            <span>Items</span>
          </div>

          <div class="mrq-items-count">
            {{ selectedReq?.lines?.length || 0 }} item(s)
          </div>
        </div>

        <div class="mrq-items-table">
          <table class="table table-sm mb-0">
            <thead class="mrq-thead">
              <tr>
                <th class="col-code">ITEM CODE</th>
                <th>ITEM NAME</th>
                <th class="col-uom">UOM</th>
                <th class="col-qty text-right">QTY</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let l of selectedReq?.lines; let i = index">
                <td class="cell-code">{{ l.itemCode || '-' }}</td>
                <td class="cell-name">{{ l.itemName || '-' }}</td>
                <td class="cell-uom">{{ l.uomName || '-' }}</td>
                <td class="cell-qty text-right">{{ l.qty ?? 0 }}</td>
              </tr>

              <tr *ngIf="(selectedReq?.lines?.length ?? 0) === 0">
                <td colspan="4" class="text-center text-muted py-4">No items</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mrq-modal-foot">
      <button class="mrq-btn-outline" (click)="close('ok')">
        <i class="fas fa-times"></i>
        <span>Close</span>
      </button>
    </div>
  </div>
</ng-template>


