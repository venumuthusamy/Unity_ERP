<div class="card card-elevated rounded-16">
  <!-- Header -->
  <div class="card-header d-flex align-items-center justify-content-between bg-white border-0">
    <h4 class="card-title mb-0" style="color:#2E5F73">Stock Transfer</h4>
    <span
      class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-semibold border"
      [ngClass]="badgeToneClasses('blue')"
      >Flow: Draft → Approve → Post</span
    >
  </div>

  <!-- Body -->
  <div class="card-body">
    <!-- Table -->
    <div class="table-responsive mt-2">
      <table class="table table-bordered mb-0 table-soft">
        <thead>
          <tr>
            <!-- Select All -->
            <th style="width:44px; background-color:#2E5F73;color:white;" class="text-center">
              <input
                type="checkbox"
                [checked]="allVisibleChecked"
                (change)="toggleSelectAll($event)"
              />
            </th>

            <th style="background-color:#2E5F73;color:white;">Warehouse</th>
            <th style="background-color:#2E5F73;color:white;">Item</th>
            <th style="background-color:#2E5F73;color:white;">SKU</th>
            <th style="background-color:#2E5F73;color:white;">Bin</th>
            <th style="background-color:#2E5F73;color:white;">Qty</th>
            <th style="background-color:#2E5F73;color:white;">Transfer Qty</th>
            <th style="background-color:#2E5F73;color:white;">Expiry</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let r of filteredRows; trackBy: trackByRow">
            <!-- Row checkbox -->
            <td class="text-center">
              <input
                type="checkbox"
                [ngModel]="r._sel"
                (ngModelChange)="onToggleRow($event, r)"
                [disabled]="isRowDisabled(r) || !r._qtyValid"
              />
            </td>

            <td>{{ r.warehouse }}</td>
            <td>{{ r.item }}</td>
            <td>{{ r.sku }}</td>
            <td>{{ r.bin }}</td>
            <td>{{ r.available }}</td>

            <!-- Transferred Qty input with inline validation -->
            <td style="min-width:140px;">
            <input
  type="number"
  class="form-control form-control-sm rounded-12"
  [ngModel]="r.transferQty"
  (ngModelChange)="onQtyChange(r, $event)"
  (keydown)="digitsOnly($event)"
  [min]="0"
  [max]="(r.available ?? 0)"   
  [readonly]="isRowDisabled(r)"
  placeholder="0"
/>

<small *ngIf="r._qtyErr === 'exceeds'" class="text-danger">
  Must be ≤ available ({{ r.available ?? 0 }})
</small>

            </td>

            <td>{{ r.expiry ? (r.expiry | date: 'yyyy-MM-dd') : '-' }}</td>
          </tr>

          <tr *ngIf="!filteredRows?.length">
            <td colspan="10" class="text-center text-muted">No rows match the filters.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Footer actions -->
    <div class="d-flex align-items-center pt-3 mt-3 border-top">
      <div class="ms-auto d-flex flex-column align-items-end">
        <small *ngIf="selectedCount > 0 && !sameWarehouseSelected" class="text-danger mb-2">
          Selected rows must be from the same warehouse.
        </small>
        <small *ngIf="hasInvalidSelected()" class="text-danger mb-2">
          Fix transfer quantities for selected rows before submitting.
        </small>

        <button
          type="button"
          class="btn btn-brand rounded-12 btn-eq"
          style="background:#2E5F73;color:#fff"
          [disabled]="selectedCount === 0 || !sameWarehouseSelected || hasInvalidSelected()"
          (click)="openSubmitModal(submitModal)"
        >
          Submit for approval ({{ selectedCount }})
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal (Submit for Approval) -->
<ng-template #submitModal let-close="close" let-dismiss="dismiss">
  <div class="modal-header" style="background:#2E5F73;color:#fff;">
    <h5 class="modal-title">Submit for Approval</h5>
    <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="dismiss('x')"></button>
  </div>

  <div class="modal-body">
    <div class="row g-3">
      <!-- From warehouse (READ-ONLY INPUT) -->
      <div class="col-md-6">
        <label class="form-label">From warehouse <span class="text-danger">*</span></label>
        <input type="text" class="form-control" [value]="fromWarehouseName || ''" readonly />
        <small class="text-danger" *ngIf="modalTouched && !modal.fromWarehouseId">Required</small>
      </div>

      <!-- To warehouse -->
      <div class="col-md-6">
        <label class="form-label">To warehouse <span class="text-danger">*</span></label>
        <ng-select
          [items]="toWarehouseList"
          bindLabel="name"
          bindValue="id"
          placeholder="Select warehouse"
          [(ngModel)]="modal.toWarehouseId"
          class="w-100"
        >
        </ng-select>
        <small class="text-danger" *ngIf="modalTouched && !modal.toWarehouseId">Required</small>
        <small class="text-danger" *ngIf="modalTouched && sameWarehouse()"
          >From/To cannot be the same</small
        >
      </div>

      <!-- Remarks -->
      <div class="col-12">
        <label class="form-label">Remarks</label>
        <textarea
          class="form-control rounded-12"
          rows="2"
          [(ngModel)]="modal.remarks"
          placeholder="Optional notes"
        ></textarea>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn btn-outline-secondary rounded-12" (click)="dismiss('cancel')">Cancel</button>
    <button class="btn rounded-12" style="background:#2E5F73;color:#fff" (click)="submitFromModal(close)">
      Submit
    </button>
  </div>
</ng-template>
