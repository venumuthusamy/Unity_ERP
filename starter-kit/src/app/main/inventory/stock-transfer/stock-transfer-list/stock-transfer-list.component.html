<div class="content-wrapper p-0">
  <div class="content-body">
    <!-- Stock Transfer List -->
    <section class="users-list-wrapper">
      <div class="card">
        <div class="row">
          <div class="col-md-6 col-12">
            <h4 class="card-text"
                style="margin-left:0.85rem;margin-top:0.75rem;font-size:1.25rem;font-weight:600;color:#2E5F73;">
              Stock Transfer List
            </h4>

            <div class="d-flex justify-content-between align-items-center m-1">
              <label class="d-flex align-items-center">Show
                <select class="form-control mx-25" [(ngModel)]="selectedOption">
                  <option [ngValue]="10">10</option>
                  <option [ngValue]="25">25</option>
                  <option [ngValue]="50">50</option>
                  <option [ngValue]="100">100</option>
                </select>
                entries
              </label>
            </div>
          </div>

          <div class="col-md-6 col-12 d-flex justify-content-start justify-content-md-end">
            <div class="d-flex align-items-center justify-content-end pr-1 pb-1 pb-md-0">
              <label class="d-flex align-items-center ml-1 ml-md-0">
                Search:
                <input [(ngModel)]="searchValue"
                       name="searchValue"
                       type="search"
                       class="form-control ml-25"
                       (keyup)="filterUpdate($event)"
                       (search)="filterUpdate($event)" />
              </label>

              <button (click)="openCreate()"
                      class="btn m-1 d-inline-flex align-items-center"
                      style="background-color:#2E5F73;color:white;gap:4px;">
                <i data-feather="plus-circle" class="w-4 h-4"></i>
                <span>Go to Transfer</span>
              </button>
            </div>
          </div>
        </div>

        <ngx-datatable class="bootstrap core-bootstrap"
                       [rows]="rows"
                       [rowHeight]="50"
                       [headerHeight]="50"
                       [footerHeight]="50"
                       [limit]="selectedOption"
                       [columnMode]="'force'"
                       [scrollbarH]="true"
                       [reorderable]="true">

          <!-- View Lines -->
          <ngx-datatable-column [width]="50"
                                [resizeable]="false"
                                [sortable]="false"
                                [draggable]="false"
                                [canAutoResize]="false">
            <ng-template ngx-datatable-cell-template let-row="row">
              <span (click)="openLinesModal(row)" title="View Details"
                    style="cursor:pointer;font-size:18px;color:#2E5F73;">
                <i class="fas fa-eye"></i>
              </span>
            </ng-template>
          </ngx-datatable-column>
          <!-- SKU column with hyperlink -->
<ngx-datatable-column name="SKU" prop="sku" [width]="140" [sortable]="true">
  <ng-template ngx-datatable-cell-template let-row="row">
<a
  [routerLink]="['/Inventory/stock-history']"
  [queryParams]="{
    sku: row.sku,
    itemId: row.itemIdNum ?? row.itemId ?? row.id,
    warehouseId: row.warehouseIdNum ?? row.warehouseId,
    stockId: row.stockIdNum ?? row.stockId
  }"
  (click)="$event.stopPropagation()"
  class="text-decoration-underline"
  style="cursor:pointer; text-decoration: underline; color: #007bff;"
>
  {{ row.sku }}
</a>
  </ng-template>
</ngx-datatable-column>

           <ngx-datatable-column name="Item Name" prop="name" [width]="160"></ngx-datatable-column>
          <ngx-datatable-column name="From Warehouse" prop="fromWarehouseName" [width]="180"></ngx-datatable-column>
        <!-- To Warehouse -->
<ngx-datatable-column name="To Warehouse" [width]="180">
  <ng-template ngx-datatable-cell-template let-row="row">
    {{ row?.toWarehouseName && row.toWarehouseName.trim() ? row.toWarehouseName : '—' }}
  </ng-template>
</ngx-datatable-column>

<!-- Transfer Qty (keep 0 as 0) -->
<ngx-datatable-column name="Transfer Qty" [width]="140">
  <ng-template ngx-datatable-cell-template let-row="row">
    {{ row?.transferQty === null || row?.transferQty === undefined ? '—' : row.transferQty }}
  </ng-template>
</ngx-datatable-column>

<!-- Reason / Remarks -->
<ngx-datatable-column name="Reason" [width]="140">
  <ng-template ngx-datatable-cell-template let-row="row">
    {{ row?.remarks && row.remarks.trim() ? row.remarks : '—' }}
  </ng-template>
</ngx-datatable-column>


          <!-- Status derived from isTransfered & isApproved -->
          <ngx-datatable-column name="Status" [width]="140">
            <ng-template let-row="row" ngx-datatable-cell-template>
              <span class="badge rounded-pill"
                    [ngClass]="row.transferStatus === 'Transferred' ? 'bg-primary'
                              : row.transferStatus === 'Pending' ? 'bg-warning'
                              : 'bg-secondary'">
                {{ row.transferStatus }}
              </span>
            </ng-template>
          </ngx-datatable-column>

          <!-- Edit/Delete -->
          <!-- <ngx-datatable-column name="Action" [width]="120">
            <ng-template let-row="row" ngx-datatable-cell-template>
              <i class="fas fa-pen text-success me-3" style="cursor:pointer" title="Edit"
                 (click)="editStockTransfer(row)"></i>

              <i class="fas fa-trash text-danger" style="cursor:pointer" title="Delete"
                 (click)="deleteStockTransfer(row.id)"></i>
            </ng-template>
          </ngx-datatable-column> -->
        </ngx-datatable>
      </div>
    </section>
  </div>
</div>

<!-- Lines Modal -->
<div *ngIf="showLinesModal"
     (click)="closeLinesModal()"
     style="position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1050;display:flex;align-items:center;justify-content:center;">
  <div (click)="$event.stopPropagation()"
       style="width:900px;max-width:95vw;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.25);">
    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #eef2f7;">
      <h3 style="margin:0;font-size:20px;line-height:1.2;font-weight:700;color:#374151;">Transfer Lines</h3>
      <button (click)="closeLinesModal()" aria-label="Close"
              style="border:0;background:transparent;font-size:22px;line-height:1;cursor:pointer;color:#6b7280;">×</button>
    </div>

    <!-- Body -->
    <div style="padding:16px 20px;">
      <div style="max-height:60vh;overflow:auto;border:1px solid #eef2f7;border-radius:10px;">
        <table style="width:100%;border-collapse:collapse;font-size:14px;color:#111827;">
        <thead>
  <tr style="background:#2E5F73;color:#fff;">
    <th style="padding:10px 12px;text-align:left;font-weight:600;">SKU</th>
    <th style="padding:10px 12px;text-align:left;font-weight:600;">Item</th>
    <th style="padding:10px 12px;text-align:left;font-weight:600;">UOM</th>
    <th style="padding:10px 12px;text-align:right;font-weight:600;width:120px;">On&nbsp;Hand</th>
    <th style="padding:10px 12px;text-align:right;font-weight:600;width:120px;">Reserved</th>
    <th style="padding:10px 12px;text-align:right;font-weight:600;width:120px;">Available</th>
    <th style="padding:10px 12px;text-align:right;font-weight:600;width:120px;">Transfer Qty</th> <!-- NEW -->
    <th style="padding:10px 12px;text-align:left;font-weight:600;">Bin</th>
    <th style="padding:10px 12px;text-align:left;font-weight:600;">Expiry</th>
    <th style="padding:10px 12px;text-align:left;font-weight:600;">Remarks</th>
  </tr>
</thead>

<tbody>
  <tr *ngFor="let l of modalLines; let i = index"
      [style.background]="i % 2 === 0 ? '#fcfdff' : '#ffffff'"
      style="border-bottom:1px solid #f1f5f9;">
    <td style="padding:10px 12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px;">
      {{ l.sku || '-' }}
    </td>
    <td style="padding:10px 12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:300px;">
      {{ l.name || '-' }}
    </td>
    <td style="padding:10px 12px;">{{ l.uom || '-' }}</td>

    <td style="padding:10px 12px;text-align:right;font-variant-numeric:tabular-nums;">
      {{ (l.onHand ?? 0) | number:'1.0-3' }}
    </td>
    <td style="padding:10px 12px;text-align:right;font-variant-numeric:tabular-nums;">
      {{ (l.reserved ?? 0) | number:'1.0-3' }}
    </td>
    <td style="padding:10px 12px;text-align:right;font-variant-numeric:tabular-nums;">
      {{ (l.availableComputed ?? l.available ?? ((l.onHand||0)-(l.reserved||0))) | number:'1.0-3' }}
    </td>
    <td style="padding:10px 12px;text-align:right;font-variant-numeric:tabular-nums;"> <!-- NEW -->
    {{ (l.transferQty ?? 0) | number:'1.0-3' }}
    </td>

    <td style="padding:10px 12px;">{{ l.binName || '-' }}</td>
    <td style="padding:10px 12px;">
      {{ l.expiryDate ? (l.expiryDate | date:'yyyy-MM-dd') : '-' }}
    </td>
    <td style="padding:10px 12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px;">
      {{ l.remarks || '-' }}
    </td>
  </tr>

  <tr *ngIf="!modalLines?.length">
    <td colspan="10" style="padding:14px 12px;text-align:center;color:#6b7280;">No lines</td>
  </tr>
</tbody>

<tfoot *ngIf="modalLines?.length">
  <tr style="background:#f3f4f6;border-top:1px solid #e5e7eb;">
    <td colspan="6" style="padding:10px 12px;font-weight:700;">Total Available</td>
    <td style="padding:10px 12px;text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">
      {{ modalTotalAvailable | number:'1.0-3' }}
    </td>
    <td colspan="3"></td>
  </tr>
</tfoot>

        </table>
      </div>
    </div>

    <!-- Footer -->
    <div style="display:flex;justify-content:flex-end;gap:8px;padding:12px 20px;border-top:1px solid #eef2f7;">
      <!-- <button 
              style="background:#2E5F73;color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer;">
        Close
      </button> -->
          <button (click)="closeLinesModal()"
              style="background:#2E5F73; color:#fff; border:0; border-radius:12px; padding:10px 18px; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:8px;">
        <i class="fas fa-times-circle"></i>
        <span>Close</span>
      </button>
    </div>
  </div>
</div>
