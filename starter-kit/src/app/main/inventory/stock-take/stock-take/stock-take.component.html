<button class="btn mb-2 position-relative d-flex align-items-center justify-content-center"
    style="background-color:#2E5F73; color:white; padding-left:2.25rem;" (click)="goToStockTakeList()">
    <i class="fas fa-arrow-left position-absolute" style="left:0.75rem; top:50%; transform:translateY(-50%);"
        aria-hidden="true"></i>
    Go to Stock Take list
</button>

<div class="card card-elevated rounded-16">
    <!-- Header -->
    <div class="card-header d-flex align-items-center justify-content-between bg-white border-0">
        <h4 class="card-title mb-0" style="color:#2E5F73">Stock Take (Cycle / Full)</h4>

        <span class="inline-flex items-center px-2 py-1 rounded-pill text-uppercase"
            style="font-size:10px; font-weight:600; border:1px solid #dbe7ee; color:#2E5F73; background:#f5fafc;">
            Plan → Freeze → Mobile Capture → Review → Post
        </span>
    </div>

    <!-- Body -->
    <div class="card-body">

        <!-- Header fields -->
        <div class="row g-3 align-items-end">
            <div class="col-sm-6 col-md-3">
                <label class="form-label">Warehouse<span style="color:red">*</span></label>
                <ng-select [items]="warehouseTypes" bindLabel="name" bindValue="id" [(ngModel)]="warehouseTypeId"
                  (ngModelChange)="onWarehouseChanged($event)"  placeholder="Select warehouse" class="w-100">
                </ng-select>
            </div>
            <div class="col-sm-6 col-md-3">
                <label class="form-label">Bin/Location<span style="color:red">*</span></label>
                <ng-select [items]="filteredLocationTypes" bindLabel="binName" bindValue="id" [(ngModel)]="locationId"
                    placeholder="Select Location" class="w-100">
                </ng-select>
            </div>
            <div class="col-sm-6 col-md-3">
                <label class="form-label">Type<span style="color:red">*</span></label>
                <ng-select [items]="takeTypes" bindLabel="label" bindValue="id" [(ngModel)]="takeTypeId"
                    placeholder="Select type" (ngModelChange)="onTypeChanged($event)" class="w-100">
                </ng-select>
            </div>

            <div class="col-sm-6 col-md-3">
                <label class="form-label">Strategy<span *ngIf = "!strategyCheck" style="color:red">*</span></label>
                <ng-select [items]="strategies" bindLabel="strategyName" bindValue="id" [(ngModel)]="strategyId"
                    placeholder="Select strategy" class="w-100" [disabled] = "strategyCheck">
                </ng-select>
            </div>

            <div class="col-sm-6 col-md-3 d-flex align-items-center" style="gap:10px;">
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="freezeChk" [(ngModel)]="freeze">
                    <label class="form-check-label" for="freezeChk">Freeze inventory</label>
                </div>
            </div>

            <div class="col-md-12 d-flex align-items-center gap-2 mt-4 justify-content-end">
                <button type="button" class="btn text-white" style="background-color:#2E5F73"
                    (click)="onSubmit()">Load</button>
            </div>
        </div>

        <!-- Table -->
         <div class="mt-2">
             <button type="button" class="btn btn-outline-primary" (click)="onExportMobileTasks()">Export Mobile
                    Tasks</button>
         </div>
         
        <div class="table-responsive mt-1">
            <table class="table table-bordered mb-0 align-middle">
                <thead>
                    <tr>
                        <th style="background-color:#2E5F73; color:white; width:200px;">Item</th>
                        <th style="background-color:#2E5F73; color:white; width:200px;">Scan/Barcode</th>
                        <th style="background-color:#2E5F73; color:white; width:120px;">Available</th>
                        <th style="background-color:#2E5F73; color:white; width:150px;white-space: nowrap;">Usable
                            Count</th>
                            <th style="background-color:#2E5F73; color:white; width:150px;white-space: nowrap;">Unusable
                            Count</th>
                        <th style="background-color:#2E5F73; color:white;width:250px;">Reason</th>    
                        <th style="background-color:#2E5F73; color:white;width:200px;">Remarks</th>
                        <!-- <th style="background-color:#2E5F73; color:white; width:200px;">Action</th> -->
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let r of lines; let i = index">
                        <td>
                            <ng-select [items]="itemList" bindLabel="name" bindValue="id" [(ngModel)]="r.itemId"
                                 placeholder="Item" class="w-100" disabled></ng-select>
                        </td>
                        <td><input type="text" class="form-control" [(ngModel)]="r.barcode"
                                placeholder="Scan or enter barcode" /></td>
                      
                        <td class="text-muted">{{ r.onHand ?? 0 }}</td>
                        <td>
                            <input type="number" class="form-control" [(ngModel)]="r.countedQty"
                                (ngModelChange)="onCountChange(r)" min="0" placeholder="0" />
                            <div *ngIf="r._error" class="small text-danger mt-1">{{ r._error }}</div>
                        </td>
                         <td>
                            <input type="number" class="form-control" [(ngModel)]="r.badCountedQty"
                                (ngModelChange)="onUnCountChange(r)" min="0" placeholder="0" />
                            <div *ngIf="r._error" class="small text-danger mt-1">{{ r._error }}</div>
                        </td>
                        <td><ng-select [items]="reasonList" bindLabel="stockIssuesNames" bindValue="id" [(ngModel)]="r.reasonId"
                                 placeholder="Item" class="w-100"></ng-select>
                        </td>
                        <td><input type="text" class="form-control" [(ngModel)]="r.remarks" placeholder="Remarks" />
                        </td>
                        <!-- <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeLine(i)">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td> -->
                    </tr>

                    <tr *ngIf="!lines.length">
                        <td colspan="7" class="text-center text-muted py-4">No lines yet.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Footer actions -->
        <div class="d-flex align-items-center pt-3 mt-3 border-top">
            <div class="d-flex align-items-center gap-2 ms-auto">
                <!-- <button type="button" class="btn btn-outline-primary" [disabled]="!lines.length"
                    (click)="openReview()">Review Variances</button> -->

                <button type="button" class="btn text-white" style="background-color:#2E5F73;" 
                    (click)="onSave(1)">Draft</button>
            </div>
        </div>

                <!-- Left-side Stock Review button -->
<div class="d-flex align-items-center justify-content-between mt-3">
  <div>
    <button
      type="button"
      class="btn"
      [class]="showStockReview ? 'btn-outline-secondary' : 'btn-outline-primary'"
      (click)="toggleStockReview()"style="background-color:#2E5F73;color:#fff">
      <i class="fas fa-clipboard-check me-1"></i>
      {{ showStockReview ? 'Hide Stock Review' : 'Stock Review' }}
    </button>
  </div>
</div>

<!-- Collapsible review panel (NO action column) -->
<div *ngIf="showStockReview" class="mt-2 border rounded-3 p-2">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex align-items-center gap-2">
      <div class="form-check me-3">
        <input  #chkSelectAllRef class="form-check-input" type="checkbox" id="chkSelectAllRef"
               [(ngModel)]="selectAllReview" (change)="toggleSelectAllReview()">
        <label class="form-check-label" for="chkSelectAllRef">Select all</label>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th style="width:42px;background-color:#2E5F73;color: #fff;"></th>
          <th style="background-color:#2E5F73;color: #fff;">Item</th>
          <th class="text-end" style="background-color:#2E5F73;color: #fff;white-space:nowrap">On Hand</th>
          <th class="text-end"style="background-color:#2E5F73;color: #fff;white-space:nowrap">Usable Count</th>
          <th class="text-end"style="background-color:#2E5F73;color: #fff;white-space:nowrap">Unusable Count</th>
          <th class="text-end"style="background-color:#2E5F73;color: #fff;white-space:nowrap">Total Count</th>
          <th class="text-end"style="background-color:#2E5F73;color: #fff;">Variance</th>
          <th class="text-end"style="background-color:#2E5F73;color: #fff;">Reason</th>
          <th class="text-end"style="background-color:#2E5F73;color: #fff;">Remarks</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of reviewRows">
          <td><input type="checkbox" [(ngModel)]="r.selected"  (change)="onRowSelectedChanged()"></td>
          <td class="text-truncate" style="max-width:220px;">
            {{ r.itemName || getItemName(r.itemId) }}
          </td>
          <td class="text-end">{{ toNum(r.onHand) }}</td>
          <td class="text-end">{{ toNum(r.countedQty) }}</td>
          <td class="text-end">{{ toNum(r.badCountedQty) }}</td>
          <td class="text-end">{{ toNum(r.countedQty) + toNum(r.badCountedQty) }}</td>
          <td class="text-end" [ngClass]="getVariance(r) >= 0 ? 'text-success' : 'text-danger'">
            {{ signed(getVariance(r)) }}
          </td>
          <td class="text-end"><ng-select [items]="reasonList" bindLabel="stockIssuesNames" bindValue="id" [(ngModel)]="r.reasonId"
                                 placeholder="Item" class="w-100"></ng-select></td>
          <td class="text-end">{{ r.remarks }}</td>
        </tr>

        <tr *ngIf="!reviewRows.length">
          <td colspan="8" class="text-center text-muted py-3">No lines to review.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
 <!-- Footer actions -->
        <div class="d-flex align-items-center pt-3 mt-3 border-top">
            <div class="d-flex align-items-center gap-2 ms-auto">
                <button type="button" class="btn text-white" style="background-color:#2E5F73;" 
                (click)="onSaveStockReview(2)">Approved</button>
            </div>
        </div>
    </div>
</div>

<!-- ===================== Review Variances Modal ===================== -->
<ng-template #reviewTpl let-modal>
    <div class="modal-header">
        <h5 class="modal-title">Review Variances</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
    </div>

    <div class="modal-body">
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th class="text-end">Available(OnHand)</th>
                        <th class="text-end">Usable Count</th>
                        <th class="text-end">UnUsable Count</th>
                         <th class="text-end">Total Count</th>
                        <th class="text-end">Variance</th>
                        <th class="text-end">Reason</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let r of lines">
                        <td>{{ r.itemName || getItemName(r.itemId) }}</td>
                        <td class="text-end">{{ toNum(r.onHand) }}</td>
                        <td class="text-end">{{ toNum(r.countedQty) }}</td>
                        <td class="text-end">{{ toNum(r.badCountedQty) }}</td>
                        <td class="text-end">{{ toNum(r.countedQty + r.badCountedQty) }}</td>
                        <td class="text-end" [ngClass]="getVariance(r) >= 0 ? 'text-success' : 'text-danger'">
                            {{ signed(getVariance(r)) }}
                        </td>
                         <td class="text-end">
                            {{ getReason(r.reasonId) }}
                        </td>
                        <td>{{ r.remarks }}</td>
                    </tr>

                    <tr *ngIf="!lines.length">
                        <td colspan="6" class="text-center text-muted py-3">No lines.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="modal.close()">Close</button>
    </div>
</ng-template>