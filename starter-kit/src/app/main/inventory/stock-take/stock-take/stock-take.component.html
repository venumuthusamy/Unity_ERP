<button class="btn mb-2 position-relative d-flex align-items-center justify-content-center"
        style="background-color:#2E5F73; color:white; padding-left:2.25rem;"
        (click)="goToStockTakeList()">
  <i class="fas fa-arrow-left position-absolute" style="left:0.75rem; top:50%; transform:translateY(-50%);" aria-hidden="true"></i>
  Go to Stock Take list
</button>

<div class="card card-elevated rounded-16">
  <!-- Header -->
  <div class="card-header d-flex align-items-center justify-content-between bg-white border-0">
    <h4 class="card-title mb-0" style="color:#2E5F73">Stock Take (Cycle / Full)</h4>

    <span class="inline-flex items-center px-2 py-1 rounded-pill text-uppercase"
          style="font-size:10px; font-weight:600; border:1px solid #dbe7ee; color:#2E5F73; background:#f5fafc;">
      Plan → Freeze → Mobile Capture → Review → Post
    </span>
  </div>

  <!-- Body -->
  <div class="card-body">

    <!-- Header fields -->
    <div class="row g-3 align-items-end">
         <div class="col-sm-6 col-md-3">
        <label class="form-label">Warehouse</label>
        <ng-select [items]="warehouseTypes" bindLabel="label" bindValue="value"
                   [(ngModel)]="warehouseType" placeholder="Select warehouse" class="w-100">
        </ng-select>
      </div>
      <div class="col-sm-6 col-md-3">
        <label class="form-label">Type</label>
        <ng-select [items]="takeTypes" bindLabel="label" bindValue="value"
                   [(ngModel)]="takeType" placeholder="Select type" class="w-100">
        </ng-select>
      </div>

      <div class="col-sm-6 col-md-3">
        <label class="form-label">Strategy</label>
        <ng-select [items]="strategies" bindLabel="label" bindValue="value"
                   [(ngModel)]="strategy" [disabled]="takeType !== 'Cycle'"
                   placeholder="Select strategy" class="w-100">
        </ng-select>
      </div>

      <div class="col-sm-6 col-md-3 d-flex align-items-center" style="gap:10px;">
        <div class="form-check mt-4">
          <input class="form-check-input" type="checkbox" id="freezeChk" [(ngModel)]="freeze">
          <label class="form-check-label" for="freezeChk">Freeze inventory</label>
        </div>
      </div>

      <div class="col-md-12 d-flex align-items-center gap-2 mt-4">
        <button type="button" class="btn text-white" style="background-color:#2E5F73" (click)="onPlan()">Plan</button>
        <button type="button" class="btn btn-outline-primary" (click)="onExportMobileTasks()">Export Mobile Tasks</button>

        <div class="ms-auto d-flex align-items-center gap-2">
          <button type="button" class="btn btn-outline-secondary" (click)="addLine()">+ Add line</button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-responsive mt-3">
      <table class="table table-bordered mb-0 align-middle">
        <thead>
          <tr>
            <th style="background-color:#2E5F73; color:white; width:180px;">Location</th>
            <th style="background-color:#2E5F73; color:white; width:280px;">Item</th>
            <th style="background-color:#2E5F73; color:white; width:120px;">Book</th>
            <th style="background-color:#2E5F73; color:white; width:140px;">Counted</th>
            <th style="background-color:#2E5F73; color:white; width:200px;">Scan/Barcode</th>
            <th style="background-color:#2E5F73; color:white;">Remarks</th>
            <th style="background-color:#2E5F73; color:white; width:60px;">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of lines; let i = index">
            <td>
              <ng-select [items]="locations" bindLabel="name" bindValue="id"
                         [(ngModel)]="r.locationId" placeholder="Location" class="w-100"></ng-select>
            </td>
            <td>
              <ng-select [items]="items" bindLabel="name" bindValue="id"
                         [(ngModel)]="r.itemId" (change)="onItemPicked(r)"
                         placeholder="Item" class="w-100"></ng-select>
            </td>
            <td class="text-muted">{{ r.bookQty ?? 0 }}</td>
            <td>
              <input type="number" class="form-control"
                     [(ngModel)]="r.counted" (ngModelChange)="onCountChange(r)"
                     min="0" placeholder="0" />
              <div *ngIf="r._error" class="small text-danger mt-1">{{ r._error }}</div>
            </td>
            <td><input type="text" class="form-control" [(ngModel)]="r.barcode" placeholder="Scan or enter barcode" /></td>
            <td><input type="text" class="form-control" [(ngModel)]="r.remarks" placeholder="Remarks" /></td>
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeLine(i)">
                <i class="fas fa-trash-alt"></i>
              </button>
            </td>
          </tr>

          <tr *ngIf="!lines.length">
            <td colspan="7" class="text-center text-muted py-4">No lines yet.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Totals -->
    <div class="d-flex justify-content-end gap-3 mt-3">
      <div class="text-muted small">Lines: <strong>{{ lines.length }}</strong></div>
      <div class="text-muted small">Total Book: <strong>{{ totalBook }}</strong></div>
      <div class="text-muted small">Total Counted: <strong>{{ totalCounted }}</strong></div>
      <div class="text-muted small">
        Total Variance:
        <strong [ngClass]="totalVariance >= 0 ? 'text-success' : 'text-danger'">
          {{ totalVariance >= 0 ? '+' : ''}}{{ totalVariance }}
        </strong>
      </div>
    </div>

    <!-- Footer actions -->
    <div class="d-flex align-items-center pt-3 mt-3 border-top">
      <div class="d-flex align-items-center gap-2 ms-auto">
        <button type="button" class="btn btn-outline-primary"
                [disabled]="!lines.length" (click)="openReview()">Review Variances</button>

        <button type="button" class="btn text-white" style="background-color:#2E5F73;"
                [disabled]="!canPost()" (click)="onPost()">Post Counts</button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== Review Variances Modal ===================== -->
<ng-template #reviewTpl let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Review Variances</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
        <tr>
          <th>Location</th>
          <th>Item</th>
          <th class="text-end">Book</th>
          <th class="text-end">Counted</th>
          <th class="text-end">Variance</th>
          <th>Remarks</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let r of lines">
          <td>{{ getLocationName(r.locationId) }}</td>
          <td>{{ r.itemName || getItemName(r.itemId) }}</td>
          <td class="text-end">{{ toNum(r.bookQty) }}</td>
          <td class="text-end">{{ toNum(r.counted) }}</td>
          <td class="text-end"
              [ngClass]="getVariance(r) >= 0 ? 'text-success' : 'text-danger'">
            {{ signed(getVariance(r)) }}
          </td>
          <td>{{ r.remarks }}</td>
        </tr>

        <tr *ngIf="!lines.length">
          <td colspan="6" class="text-center text-muted py-3">No lines.</td>
        </tr>
        </tbody>

        <tfoot *ngIf="lines.length">
        <tr class="fw-semibold">
          <td colspan="2" class="text-end">Totals:</td>
          <td class="text-end">{{ totalBook }}</td>
          <td class="text-end">{{ totalCounted }}</td>
          <td class="text-end" [ngClass]="totalVariance >= 0 ? 'text-success' : 'text-danger'">
            {{ signed(totalVariance) }}
          </td>
          <td></td>
        </tr>
        </tfoot>
      </table>
    </div>

    <div class="alert alert-info small mb-0">
      <strong>Tip:</strong> Use this review to spot mistakes. If anything looks wrong, close this dialog to adjust the lines before posting.
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="modal.close()">Close</button>
    <button type="button" class="btn btn-primary" [disabled]="!canPost()"
            (click)="confirmPostFromReview(modal)">Post Counts</button>
  </div>
</ng-template>
