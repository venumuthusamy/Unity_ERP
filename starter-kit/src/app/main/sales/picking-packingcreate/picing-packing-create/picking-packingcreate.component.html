<div class="pp-card shadow-sm">
  <!-- Header -->
  <div class="pp-header d-flex justify-content-between align-items-center">
    <h5 class="m-0">Picking &amp; Packing</h5>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" (click)="resetForm()">Clear</button>
      <button class="btn btn-primary" (click)="saveDo()"
              [disabled]="!selectedSoId || !hasAnyDeliverQty()">
        Generate DO
      </button>
    </div>
  </div>

  <div class="pp-body">
    <!-- Top row (ONLY Sales Order) -->
    <div class="row g-3 mb-2">
      <div class="col-lg-4 col-md-6">
        <label class="form-label">Sales Order</label>
        <ng-select
          [items]="soList"
          bindLabel="number"
          bindValue="id"
          [(ngModel)]="selectedSoId"
          name="soId"
          [searchable]="true"
          [clearable]="true"
          placeholder="Select SO…"
          (change)="onSoChanged(selectedSoId)">
          <ng-template ng-label-tmp let-item="item">
            {{ item.number }} — {{ item.customerName }}
          </ng-template>
          <ng-template ng-option-tmp let-item="item">
            {{ item.number }} — {{ item.customerName }}
          </ng-template>
        </ng-select>
      </div>

      <!-- (Optional) read-only SO info -->
      <div class="col-lg-4 col-md-6" *ngIf="soHdr?.customerName">
        <label class="form-label">Customer</label>
        <input class="form-control" [value]="soHdr.customerName" readonly />
      </div>
      <div class="col-lg-4 col-md-6" *ngIf="soHdr?.soDate">
        <label class="form-label">SO Date</label>
        <input class="form-control" [value]="soHdr.soDate | date:'mediumDate'" readonly />
      </div>
    </div>

    <!-- Grid -->
    <div class="table-responsive">
      <table class="table align-middle pp-table">
        <thead>
          <tr>
            <th>Item</th>
            <th style="width:170px">Pick From Bin</th>
            <th class="text-end" style="width:140px">Qty</th>
            <th style="width:220px">Pack to Carton</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let r of rows; trackBy: trackByLine">
            <td class="pp-item">
              <div class="fw-semibold">{{ r.itemName }}</div>
              <div class="text-muted small">
                {{ r.sku }}&nbsp;•&nbsp;{{ r.uom }}
                <span class="ms-1" *ngIf="r.pendingQty !== null">
                  (Pending: {{ r.pendingQty | number:'1.0-2' }})
                </span>
              </div>
            </td>

            <td>
              <input class="form-control" [(ngModel)]="r.pickBin" name="bin{{r.id}}" placeholder="A-01-01" />
            </td>

            <td class="text-end">
              <input type="number"
                     class="form-control text-end"
                     [(ngModel)]="r.deliverQty"
                     [min]="0"
                     [max]="r.pendingQty ?? null"
                     (ngModelChange)="recalcTotals()">
            </td>

            <td>
              <ng-select
                [items]="cartonOptions"
                bindLabel="name"
                bindValue="id"
                [(ngModel)]="r.cartonId"
                placeholder="Select carton…">
              </ng-select>
            </td>
          </tr>

          <tr *ngIf="!selectedSoId">
            <td colspan="4" class="text-center text-muted">Choose a Sales Order to view items</td>
          </tr>
          <tr *ngIf="selectedSoId && !rows?.length">
            <td colspan="4" class="text-center text-muted">No pickable lines for this Sales Order</td>
          </tr>
        </tbody>

        <tfoot *ngIf="rows?.length">
          <tr class="table-light">
            <th colspan="2" class="text-end">Total Qty</th>
            <th class="text-end">{{ totalDeliverQty | number:'1.0-2' }}</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Bottom right CTA (visual match to your screenshot) -->
    <div class="d-flex justify-content-end mt-3">
      <button class="btn btn-dark pp-primary"
              (click)="saveDo()"
              [disabled]="!selectedSoId || !hasAnyDeliverQty()">
        <i class="fa fa-truck me-2" aria-hidden="true"></i>
        Generate DO
      </button>
    </div>
  </div>
</div>
