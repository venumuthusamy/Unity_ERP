<!-- Keep bottom space small (no sticky) -->
<div class="so-page ui-compact pr-typography">

  <div class="bg-white rounded-2xl shadow px-2 pt-2 pb-6 border border-gray-100 so-card">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold text-gray-800">Sales Order</h2>
      <div class="pill" [ngClass]="soHdr.statusClass">{{ soHdr.statusText }}</div>
    </div>

    <!-- Header: searchText pattern -->
    <div [ngClass]="gridColsClass(4)">

      <!-- Quotation -->
      <div class="so-header-dd dropdown-input">
        <label class="text-xs font-medium text-gray-600">Quotation No</label>
        <div class="relative">
          <input type="text"
                 [(ngModel)]="searchTexts['quotationNo']"
                 (input)="filter('quotationNo')"
                 (focus)="toggleDropdown('quotationNo', true)"
                 placeholder="Search Quotation No..."
                 class="w-full rounded-xl border focus:outline-none focus:ring-2 px-4 py-2 text-sm"
                 style="border-color:#0e3a4c"/>
          <button *ngIf="searchTexts['quotationNo']" type="button"
                  (click)="onClearSearch('quotationNo')"
                  class="absolute inset-y-0 right-7 flex items-center text-gray-400 hover:text-gray-600 px-2 btn-clear">✕</button>
          <button type="button" (click)="toggleDropdown('quotationNo')"
                  class="absolute inset-y-0 right-2 flex items-center text-gray-500 px-2 btn-caret">▼</button>
        </div>
        <p *ngIf="submitted && isEmpty(searchTexts['quotationNo'])" class="text-xs text-red-600 mt-1">
          Quotation No is required.
        </p>

        <ul *ngIf="dropdownOpen['quotationNo']"
            class="absolute top-full left-0 right-0 bg-white border rounded-xl mt-1 shadow z-10 max-h-40 overflow-y-auto">
          <li *ngFor="let c of filteredLists['quotationNo']"
              (click)="select('quotationNo', c)"
              class="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm">
            {{ c.name }}
          </li>
        </ul>
      </div>
      <!-- Customer -->
      <div class="so-header-dd dropdown-input">
        <label class="text-xs font-medium text-gray-600">Customer</label>
        <div class="relative">
          <input type="text"
                 [(ngModel)]="searchTexts['customer']"
                 (input)="filter('customer')"
                 (focus)="toggleDropdown('customer', true)"
                 placeholder="Search Customer..."
                 class="w-full rounded-xl border focus:outline-none focus:ring-2 px-4 py-2 text-sm"
                 style="border-color:#0e3a4c"/>
          <button *ngIf="searchTexts['customer']" type="button"
                  (click)="onClearSearch('customer')"
                  class="absolute inset-y-0 right-7 flex items-center text-gray-400 hover:text-gray-600 px-2 btn-clear">✕</button>
          <button type="button" (click)="toggleDropdown('customer')"
                  class="absolute inset-y-0 right-2 flex items-center text-gray-500 px-2 btn-caret">▼</button>
        </div>
        <p *ngIf="submitted && isEmpty(searchTexts['customer'])" class="text-xs text-red-600 mt-1">
          Customer is required.
        </p>

        <ul *ngIf="dropdownOpen['customer']"
            class="absolute top-full left-0 right-0 bg-white border rounded-xl mt-1 shadow z-10 max-h-40 overflow-y-auto">
          <li *ngFor="let c of filteredLists['customer']"
              (click)="select('customer', c)"
              class="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm">
            {{ c.name }}
          </li>
        </ul>
      </div>

      <!-- Warehouse -->
      <div class="so-header-dd dropdown-input">
        <label class="text-xs font-medium text-gray-600">Warehouse</label>
        <div class="relative">
          <input type="text"
                 [(ngModel)]="searchTexts['warehouse']"
                 (input)="filter('warehouse')"
                 (focus)="toggleDropdown('warehouse', true)"
                 placeholder="Search Warehouse..."
                 class="w-full rounded-xl border focus:outline-none focus:ring-2 px-4 py-2 text-sm"
                 style="border-color:#0e3a4c"/>
          <button *ngIf="searchTexts['warehouse']" type="button"
                  (click)="onClearSearch('warehouse')"
                  class="absolute inset-y-0 right-7 flex items-center text-gray-400 hover:text-gray-600 px-2 btn-clear">✕</button>
          <button type="button" (click)="toggleDropdown('warehouse')"
                  class="absolute inset-y-0 right-2 flex items-center text-gray-500 px-2 btn-caret">▼</button>
        </div>

        <ul *ngIf="dropdownOpen['warehouse']"
            class="absolute top-full left-0 right-0 bg-white border rounded-xl mt-1 shadow z-10 max-h-40 overflow-y-auto">
          <li *ngFor="let w of filteredLists['warehouse']"
              (click)="select('warehouse', w)"
              class="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm">
            {{ w.name }}
          </li>
        </ul>
      </div>

      <!-- Requested Date -->
      <div>
        <label class="text-xs font-medium text-gray-600">Requested Date</label>
        <input class="w-full rounded-xl border px-3 py-2 text-sm"
               style="border-color:#0e3a4c" type="date"
               [(ngModel)]="soHdr.requestedDate"/>
      </div>

      <!-- Promised Date -->
      <div>
        <label class="text-xs font-medium text-gray-600">Delivery Date</label>
        <input class="w-full rounded-xl border px-3 py-2 text-sm"
               style="border-color:#0e3a4c" type="date"
               [(ngModel)]="soHdr.deliveryDate"/>
      </div>
    </div>

    <!-- Reserve / Release -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
      <!-- <div class="text-sm text-gray-600">
        Allocation Status:
        <span class="badge" [class.badge-ok]="allocation.reservedPct>0">Reserved {{ allocation.reservedPct }}%</span>
      </div> -->
      <div class="flex gap-2 md:justify-end md:col-start-2 md:justify-self-end">
        <button type="button" class="btn-outline" (click)="reserveStock()">Reserve Stock</button>
        <button type="button" class="btn-dark" (click)="releaseToPicking()">Release to Picking</button>
      </div>
    </div>

    <!-- Lines table -->
    <div class="mt-4 overflow-auto border border-gray-200 rounded-lg">
      <table class="min-w-full text-sm">
        <thead class="text-white" style="background-color:#2E5F73">
          <tr>
            <th class="th">Item</th>
            <th class="th">UOM</th>
            <th class="th">Qty</th>
            <th class="th">Unit Price</th>
            <th class="th">Discount %</th>
            <th class="th">Tax</th>
            <th class="th">Total</th>
            <th class="th text-right">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="soLines.length===0">
            <td [attr.colspan]="8" class="px-3 py-6 text-center text-gray-400">No lines yet.</td>
          </tr>

          <tr *ngFor="let ln of soLines; let i=index; trackBy: trackByIndex" class="border-t">
            <!-- Item (searchText style) -->
            <td class="td relative so-line-dd dropdown-input">
              <input type="text"
                     class="w-52 rounded-xl border px-3 py-2 text-sm"
                     style="border-color:#0e3a4c"
                     [(ngModel)]="soLines[i].item"
                     (focus)="openDropdown(i,'item')"
                     (input)="filterOptions(i,'item')"
                     placeholder="Search Item...">
              <div *ngIf="soLines[i].dropdownOpen==='item'"
                   class="absolute left-0 top-full mt-1 w-64 bg-white border rounded-xl shadow-lg max-h-56 overflow-y-auto z-50">
                <div *ngFor="let it of soLines[i].filteredOptions"
                     (click)="selectOption(i,'item', it)"
                     class="px-3 py-2 cursor-pointer hover:bg-gray-100 text-sm flex justify-between">
                  <span>{{ it.itemCode }}</span>
                  <span class="text-gray-500">{{ it.itemName }}</span>
                </div>
              </div>
            </td>

            <!-- UOM -->
            <td class="td">
              <input class="w-24 rounded-xl border px-3 py-2 text-sm"
                     style="border-color:#0e3a4c"
                     [(ngModel)]="soLines[i].uom" placeholder="UOM">
            </td>

            <!-- Qty -->
            <td class="td">
              <input type="number" class="w-24 rounded-xl border px-3 py-2 text-sm text-right"
                     style="border-color:#0e3a4c"
                     [(ngModel)]="soLines[i].qty" (input)="recalcLine(i)">
            </td>

            <!-- Unit Price -->
            <td class="td">
              <input type="number" class="w-28 rounded-xl border px-3 py-2 text-sm text-right"
                     style="border-color:#0e3a4c"
                     [(ngModel)]="soLines[i].unitPrice" (input)="recalcLine(i)">
            </td>

            <!-- Discount % -->
            <td class="td">
              <input type="number" class="w-24 rounded-xl border px-3 py-2 text-sm text-right"
                     style="border-color:#0e3a4c"
                     [(ngModel)]="soLines[i].discountPct" (input)="recalcLine(i)">
            </td>

            <!-- Tax (searchText style minimal) -->
            <td class="td relative so-line-dd dropdown-input">
              <input type="text" class="w-28 rounded-xl border px-3 py-2 text-sm"
                     style="border-color:#0e3a4c"
                     [(ngModel)]="soLines[i].taxCode"
                     (focus)="openDropdown(i,'taxCode')"
                     (input)="filterOptions(i,'taxCode')"
                     placeholder="Search Tax...">
              <div *ngIf="soLines[i].dropdownOpen==='taxCode'"
                   class="absolute left-0 top-full mt-1 w-40 bg-white border rounded-xl shadow-lg max-h-56 overflow-y-auto z-50">
                <div *ngFor="let t of soLines[i].filteredOptions"
                     (click)="selectOption(i,'taxCode', t)"
                     class="px-3 py-2 cursor-pointer hover:bg-gray-100 text-sm flex justify-between">
                  <span>{{ t.code }}</span>
                  <span class="text-gray-500">{{ t.name }}</span>
                </div>
              </div>
            </td>

            <!-- Total -->
            <td class="td text-right">{{ (soLines[i].total || 0) | number:'1.2-2' }}</td>

            <!-- Action -->
            <td class="td text-right">
              <button class="btn-link" (click)="removeLine(i)">Remove</button>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="p-2 border-t bg-gray-50">
        <button class="btn-add" type="button" (click)="addLine()">+ Add line</button>
      </div>
    </div>

    <!-- Totals -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
      <div class="md:col-span-2"></div>
      <div class="so-totals">
        <div class="so-row">
          <span>Sub Total</span>
          <span class="so-num">{{ totals.subTotal | number:'1.2-2' }}</span>
        </div>
        <div class="so-row">
          <span>Shipping</span>
          <input type="number" class="so-inp so-w-24" [(ngModel)]="soHdr.shipping" (input)="recalcTotals()">
        </div>
        <div class="so-row">
          <span>Discount (absolute)</span>
          <input type="number" class="so-inp so-w-24" [(ngModel)]="soHdr.discount" (input)="recalcTotals()">
        </div>
        <div class="so-row">
          <span>GST (%)</span>
          <input type="number" class="so-inp so-w-24" [(ngModel)]="soHdr.gstPct" (input)="recalcTotals()">
        </div>
        <div class="so-row so-total">
          <span>Net Total</span>
          <span class="so-num">{{ totals.netTotal | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>
    <div class="mt-4 pt-3 border-t flex flex-wrap gap-2 justify-end so-actions">
      <button class="so-btn so-btn-primary" (click)="post()">Save</button>
      <button class="so-btn so-btn-danger"  (click)="cancel()">Cancel</button>
    </div>
  </div>
</div>
