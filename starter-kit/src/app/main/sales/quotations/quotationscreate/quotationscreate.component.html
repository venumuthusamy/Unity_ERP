<!-- Back button -->
<button
  (click)="goToList()"
  class="btn mb-2 position-relative d-flex align-items-center justify-content-center"
  style="background-color:#2E5F73; color:white; padding-left:2.25rem;"
>
  <i
    class="fas fa-arrow-left position-absolute"
    style="left:0.75rem; top:50%; transform:translateY(-50%);"
    aria-hidden="true"
  ></i>
  <span>Go to QT list</span>
</button>

<div class="space-y-1 ui-compact pr-typography">
  <div class="bg-white rounded-2xl shadow p-2 border border-gray-100">
    <div class="d-flex align-items-center justify-content-between mb-1">
      <h2 class="text-lg fw-semibold text-gray-800 m-0">
        Quotation (QT)
      </h2>
      <div class="d-flex gap-2">
        <span class="badge bg-light text-dark">
          Status: {{ statusLabel(header.status) }}
        </span>
        <span class="text-muted" *ngIf="header.needsHodApproval">
          Discounts above 10% need HOD approval
        </span>
      </div>
    </div>

    <!-- Header -->
    <div class="row g-2">
      <!-- Customer -->
      <div class="col-md-3">
        <label class="form-label form-label-xs">Customer</label>
        <div class="position-relative" #customerBox>
          <input
            type="text"
            class="form-control prl-input"
            placeholder="Search customer..."
            [(ngModel)]="customerSearch"
            name="customerSearch"
            autocomplete="off"
            (focus)="openCustomerDropdown()"
            (input)="filterCustomers()"
          />

          <div
            *ngIf="customerDdOpen"
            class="prl-menu"
            style="max-height:220px; overflow:auto;"
          >
            <div
              class="prl-mi prl-mi-split"
              *ngFor="let c of filteredCustomers"
              (mousedown)="$event.preventDefault()"
              (click)="selectCustomer(c)"
            >
              <span class="truncate">{{ c.name }}</span>
            </div>
            <div class="prl-mi prl-muted" *ngIf="!filteredCustomers?.length">
              No results
            </div>
          </div>
        </div>

        <small class="text-muted d-block mt-1" *ngIf="activeCustomerCountry">
          Country: {{ activeCustomerCountry?.countryName }} • GST:
          {{ header.taxPct || 0 }}%
        </small>
      </div>

      <!-- ✅ Delivery Date (ValidityDate replaced) -->
      <div class="col-md-3">
        <label class="text-xs font-medium text-gray-600">
          Delivery Date
        </label>
        <input
          #dateInput
          type="date"
          class="w-100 rounded-xl border px-3 py-2 text-sm focus:outline-none cursor-pointer"
          style="border-color:#0e3a4c;"
          [(ngModel)]="header.deliveryDate"
          name="deliveryDate"
          [min]="minDate"
          (click)="dateInput.showPicker?.()"
          (focus)="dateInput.showPicker?.()"
          inputmode="none"
          autocomplete="off"
        />
      </div>

      <!-- Currency -->
      <div class="col-md-3">
        <label class="form-label form-label-xs">Currency</label>
        <div class="position-relative" #currencyBox>
          <input
            type="text"
            class="form-control prl-input"
            placeholder="Type to search currency..."
            [(ngModel)]="currencySearch"
            name="currencySearch"
            autocomplete="off"
            (focus)="openCurrencyDropdown()"
            (input)="filterCurrencies()"
          />

          <div
            *ngIf="currencyDdOpen"
            class="prl-menu"
            style="max-height:220px; overflow:auto;"
          >
            <div
              class="prl-mi"
              *ngFor="let cur of filteredCurrencies"
              (mousedown)="$event.preventDefault()"
              (click)="selectCurrency(cur)"
            >
              {{ cur.name }}
            </div>
            <div class="prl-mi prl-muted" *ngIf="!filteredCurrencies?.length">
              No results
            </div>
          </div>
        </div>
      </div>

      <!-- FX Rate -->
      <div class="col-md-3">
        <label class="form-label form-label-xs">FX Rate</label>
        <input
          type="number"
          class="form-control"
          [(ngModel)]="header.fxRate"
          name="fxRate"
          step="0.000001"
        />
      </div>

      <!-- Payment Terms -->
      <div class="col-md-3">
        <label class="form-label form-label-xs">Payment Terms</label>
        <div class="position-relative" #paymentBox>
          <input
            type="text"
            class="form-control prl-input"
            placeholder="Search payment terms..."
            [(ngModel)]="paymentTermsSearch"
            name="paymentTermsSearch"
            autocomplete="off"
            (focus)="openPaymentTermsDropdown()"
            (input)="filterPaymentTerms()"
          />

          <div
            *ngIf="paymentTermsDdOpen"
            class="prl-menu"
            style="max-height:220px; overflow:auto;"
          >
            <div
              class="prl-mi"
              *ngFor="let p of filteredPaymentTerms"
              (mousedown)="$event.preventDefault()"
              (click)="selectPaymentTerms(p)"
            >
              {{ p.name }}
            </div>
            <div class="prl-mi prl-muted" *ngIf="!filteredPaymentTerms?.length">
              No results
            </div>
          </div>
        </div>
      </div>

      <!-- GST% (read-only) -->
      <div class="col-md-3">
        <label class="form-label form-label-xs">GST %</label>
        <input
          type="number"
          class="form-control"
          [(ngModel)]="header.taxPct"
          name="taxPct"
          step="0.01"
          readonly
        />
        <small class="text-muted">
          Derived from customer's country.
        </small>
      </div>
    </div>

    <!-- Lines -->
    <div class="mt-2 border rounded-2xl overflow-hidden">
      <table class="table m-0 align-middle qt-table">
        <thead>
          <tr>
            <th class="px-3 py-2" style="background:#2E5F73;color:#fff;">Item</th>
            <th style="background:#2E5F73;color:#fff;">Description</th>
            <th style="background:#2E5F73;color:#fff;">UOM</th>
            <th class="text-center" style="background:#2E5F73;color:#fff;">Qty</th>
            <th class="text-center" style="background:#2E5F73;color:#fff;">Unit Price</th>
            <th class="text-center" style="background:#2E5F73;color:#fff;">Discount %</th>
            <th style="background:#2E5F73;color:#fff;">Tax Mode</th>
            <th class="text-center" style="background:#2E5F73;color:#fff;">Line Total</th>
            <th class="text-center" style="background:#2E5F73;color:#fff;">Action</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngIf="lines.length === 0">
            <td class="text-center text-muted py-4" [attr.colspan]="9">
              No lines yet.
            </td>
          </tr>

          <tr *ngFor="let l of lines; let i = index">
            <td>
              {{ l.itemName || getItemName(l.itemId) || '(select)' }}
            </td>

            <!-- ✅ Description binding -->
            <td>
              {{ l.description || '-' }}
            </td>

            <td>{{ getUomName(l.uomId) }}</td>
            <td class="text-center">{{ l.qty }}</td>
            <td class="text-center">{{ l.unitPrice | number:'1.2-4' }}</td>
            <td class="text-center">{{ l.discountPct | number:'1.0-2' }}</td>
            <td>{{ l.taxMode }}</td>
            <td class="text-center">{{ l.lineTotal | number:'1.2-2' }}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-link" (click)="openEdit(i)" title="Edit">
                <i class="fas fa-pen text-primary"></i>
              </button>
              <button class="btn btn-sm btn-link" (click)="remove(i)" title="Remove">
                <i class="fas fa-trash text-danger"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="p-2 border-top bg-light">
        <button
          class="btn btn-sm text-white"
          type="button"
          (mouseenter)="hoverAdd=true"
          (mouseleave)="hoverAdd=false"
          [style.background-color]="hoverAdd ? '#0b2e3d' : '#2E5F73'"
          (click)="openAdd()"
        >
          + Add line
        </button>
      </div>
    </div>

    <!-- Totals -->
    <div class="row mt-2">
      <div class="col-md-8"></div>

      <div class="col-md-4">
        <div class="p-1 border rounded-3">
          <div class="d-flex justify-content-between mb-1">
            <span>Subtotal</span>
            <strong>{{ header.subtotal | currency:header.currency }}</strong>
          </div>

          <div class="d-flex justify-content-between mb-1 align-items-center">
            <span>Discount</span>
            <div class="d-flex align-items-center">
              <input
                type="number"
                class="form-control me-1"
                style="width: 120px;"
                [(ngModel)]="header.discountInput"
                name="docDiscountInput"
                (ngModelChange)="onDiscountChange()"
              />

              <select
                class="form-select"
                style="width: 90px;"
                [(ngModel)]="header.discountType"
                name="docDiscountType"
                (change)="onDiscountTypeChange($event.target.value)"
              >
                <option value="VALUE">Amt</option>
                <option value="PERCENT">%</option>
              </select>
            </div>
          </div>

          <div class="d-flex justify-content-between mb-1">
            <span>Tax</span>
            <strong>{{ header.taxAmount | currency:header.currency }}</strong>
          </div>

          <hr class="my-2" />

          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Grand Total</span>
            <h4 class="m-0">{{ header.grandTotal | currency:header.currency }}</h4>
          </div>
        </div>

        <div class="d-flex gap-2 mt-2">
          <button
            class="btn text-white ms-auto"
            type="button"
            (click)="save()"
            style="background-color:#2E5F73;"
          >
            Save
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Line Modal -->
<div *ngIf="showModal" class="prl-overlay" aria-modal="true" role="dialog">
  <div class="prl-modal" (click)="onModalContainer($event)">
    <div class="prl-head">
      <h2 class="prl-title">
        {{ editingIndex === null ? 'Add Quotation Line' : 'Edit Quotation Line' }}
      </h2>
      <button class="prl-close" (click)="closeModal()">✕</button>
    </div>

    <form (ngSubmit)="submitModal()">
      <div class="prl-grid">
        <!-- Item search -->
        <div class="prl-col-12 prl-md-6 prl-dropdown" #modalItemBox>
          <label class="prl-label">Item</label>
          <input
            #itemSearchInput
            class="prl-input pr-10"
            name="itemSearch"
            [(ngModel)]="modal.itemSearch"
            (focus)="onModalItemFocus(true)"
            (input)="filterModalItems()"
            placeholder="Search Item..."
            autocomplete="off"
          />
          <div class="prl-menu" *ngIf="modal.dropdownOpen">
            <ng-container *ngIf="modal.filteredItems?.length; else noMatches">
              <div
                class="prl-mi prl-mi-split"
                *ngFor="let row of modal.filteredItems; trackBy: trackByItemId"
                (mousedown)="$event.preventDefault()"
                (click)="selectModalItem(row)"
              >
                <span class="truncate">{{ row.itemName }}</span>
                <small class="prl-muted ml-3">{{ row.itemCode }}</small>
              </div>
            </ng-container>
            <ng-template #noMatches>
              <div class="prl-mi text-gray-400">No matches</div>
            </ng-template>
          </div>
        </div>

        <!-- Qty -->
        <div class="prl-col-6 prl-md-3">
          <label class="prl-label">Qty</label>
          <input
            type="number"
            class="prl-input"
            [(ngModel)]="modal.qty"
            name="qty"
            (ngModelChange)="previewLineTotals()"
          />
        </div>

        <!-- UOM -->
        <div class="prl-col-6 prl-md-3">
          <label class="prl-label">UOM</label>
          <input
            class="prl-input"
            [value]="getUomName(modal.uomId)"
            placeholder="UOM"
            readonly
          />
        </div>

        <!-- Unit Price -->
        <div class="prl-col-6 prl-md-3">
          <label class="prl-label">Unit Price</label>
          <input
            type="number"
            class="prl-input"
            [(ngModel)]="modal.unitPrice"
            name="unitPrice"
            step="0.0001"
            (ngModelChange)="previewLineTotals()"
          />
        </div>

        <!-- Discount -->
        <div class="prl-col-6 prl-md-3">
          <label class="prl-label">Discount %</label>
          <input
            type="number"
            class="prl-input"
            [(ngModel)]="modal.discountPct"
            name="discountPct"
            step="0.01"
            (ngModelChange)="previewLineTotals()"
          />
        </div>

        <!-- Tax Mode -->
        <div class="prl-col-12 prl-md-6">
          <label class="prl-label">Tax Mode (Line)</label>

          <select
            class="prl-input"
            [(ngModel)]="modal.taxMode"
            name="taxMode"
            (ngModelChange)="previewLineTotals()"
          >
            <option *ngFor="let m of taxModesForCurrentGst" [ngValue]="m">
              {{ m }}
            </option>
          </select>

          <small class="text-gray-500">
            GST% used: {{ modal.taxMode === 'Standard-Rated' ? (header.taxPct || 0) : 0 }}%
          </small>
        </div>

        <!-- ✅ Description (modal) -->
        <div class="prl-col-12">
          <label class="prl-label">Description</label>
          <textarea
            class="prl-input"
            rows="2"
            [(ngModel)]="modal.description"
            name="description"
            placeholder="Enter description..."
          ></textarea>
        </div>

        <!-- Live preview -->
        <div class="prl-col-12" *ngIf="modalPreview">
          <div class="mt-2 p-2 rounded border bg-light">
            <div class="d-flex justify-content-between small">
              <span>Net</span>
              <strong>{{ modalPreview.net | number:'1.2-2' }}</strong>
            </div>
            <div class="d-flex justify-content-between small">
              <span>Tax</span>
              <strong>{{ modalPreview.tax | number:'1.2-2' }}</strong>
            </div>
            <div class="d-flex justify-content-between">
              <span>Total</span>
              <strong>{{ modalPreview.total | number:'1.2-2' }}</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal footer -->
      <div class="prl-foot" *ngIf="editingIndex !== null; else addFooter">
        <button type="button" class="prl-btn" (click)="closeModal()">
          Cancel
        </button>
        <button type="submit" class="prl-btn prl-btn-primary">
          Save Changes
        </button>
      </div>

      <ng-template #addFooter>
        <div class="prl-foot">
          <button type="submit" class="prl-btn prl-btn-primary">
            Add &amp; Close
          </button>
          <button type="button" class="prl-btn" (click)="closeModal()">
            Close
          </button>
        </div>
      </ng-template>
    </form>
  </div>
</div>
