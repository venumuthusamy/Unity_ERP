<button (click)="goDoList()"
        class="btn mb-2 position-relative d-flex align-items-center justify-content-center"
        style="background-color:#2E5F73; color:white; padding-left:2.25rem;">
  <i class="fas fa-arrow-left position-absolute"
     style="left:0.75rem; top:50%; transform:translateY(-50%);" aria-hidden="true"></i>
  <span>Go to DO list</span>
</button>

<div class="card shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="m-0">
      {{ isEdit ? 'Edit Delivery Order' : 'Create Delivery Order' }}
      <small *ngIf="isEdit && doId" class="text-muted ms-2">#{{ doId }}</small>
      <span *ngIf="isEdit && isPosted" class="badge bg-success ms-2">Posted</span>
    </h5>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" (click)="resetForm()">Clear</button>
      <button class="btn btn-primary"
              (click)="saveDo()"
              [disabled]="!selectedSoId || !deliveryDate || !driverId || !vehicleId || (isEdit && isPosted)">
        {{ isEdit ? 'Update Header' : 'Save DO' }}
      </button>
    </div>
  </div>

  <div class="card-body">
    <!-- Header form -->
    <div class="row g-3">
      <div class="col-lg-3 col-md-6">
        <label class="form-label">Sales Order</label>
        <ng-select
          [items]="soList"
          bindLabel="salesOrderNo"
          bindValue="id"
          [(ngModel)]="selectedSoId"
          name="soId"
          [searchable]="true"
          [clearable]="true"
          placeholder="Select SO…"
          [disabled]="isEdit"
          (change)="onSoChanged(selectedSoId)">
          <ng-template ng-label-tmp let-item="item">
            {{ item.salesOrderNo }} — {{ item.customerName }}
          </ng-template>
          <ng-template ng-option-tmp let-item="item">
            {{ item.salesOrderNo }} — {{ item.customerName }}
          </ng-template>
        </ng-select>
      </div>

      <div class="col-lg-3 col-md-6">
        <label class="form-label">Driver</label>
        <ng-select
          [items]="driverList"
          bindLabel="name"
          bindValue="id"
          [(ngModel)]="driverId"
          name="driverId"
          [searchable]="true"
          [clearable]="true"
          placeholder="Select driver…"
          [disabled]="isPosted">
        </ng-select>
      </div>

      <div class="col-lg-3 col-md-6">
        <label class="form-label">Vehicle</label>
        <ng-select
          [items]="vehicleList"
          bindValue="id"
          [(ngModel)]="vehicleId"
          name="vehicleId"
          [searchable]="true"
          [clearable]="true"
          placeholder="Select vehicle…"
          [disabled]="isPosted">
          <ng-template ng-label-tmp let-item="item">
            {{ item.vehicleNo }}<span *ngIf="item.vehicleType"> ({{ item.vehicleType }})</span>
          </ng-template>
          <ng-template ng-option-tmp let-item="item">
            {{ item.vehicleNo }}<span *ngIf="item.vehicleType"> ({{ item.vehicleType }})</span>
          </ng-template>
        </ng-select>
      </div>

      <div class="col-lg-3 col-md-6">
        <label class="form-label">Route</label>
        <input type="text" class="form-control"
               placeholder="Enter route…" [(ngModel)]="routeText"
               name="routeText" [disabled]="isPosted" autocomplete="off" />
      </div>

      <div class="col-lg-3 col-md-6">
        <label class="form-label">Delivery Date</label>
        <input type="date" class="form-control"
               [(ngModel)]="deliveryDate" name="deliveryDate"
               [min]="today" [disabled]="isPosted">
      </div>
    </div>

    <!-- CREATE MODE -->
    <div class="mt-4" *ngIf="!isEdit">
      <h6 class="mb-2">Items (from Sales Order)</h6>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th style="width:120px">UOM</th>
              <th class="text-end" style="width:140px">Ordered</th>
              <th class="text-end" style="width:140px">Pending</th>
              <th class="text-end" style="width:160px">Deliver Qty</th>
              <th style="width:220px">Notes</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let l of soLines; trackBy: trackBySoLineId">
              <td>{{ l.itemName }}</td>
              <td>{{ uomLabel(l.uom) }}</td>
              <td class="text-end">{{ l.orderedQty | number:'1.0-2' }}</td>
              <td class="text-end">{{ l.pendingQty | number:'1.0-2' }}</td>
              <td class="text-end">
                <input type="number" class="form-control text-end"
                       [(ngModel)]="l.deliverQty" [min]="0" [max]="l.pendingQty"
                       (ngModelChange)="recalcTotals()">
              </td>
              <td><input class="form-control" [(ngModel)]="l.notes" placeholder="(optional)"></td>
            </tr>
            <tr *ngIf="!selectedSoId">
              <td colspan="6" class="text-center text-muted">Choose a Sales Order to view items</td>
            </tr>
            <tr *ngIf="selectedSoId && !soLines?.length">
              <td colspan="6" class="text-center text-muted">No lines found for this Sales Order</td>
            </tr>
          </tbody>
          <tfoot *ngIf="soLines?.length">
            <tr class="table-light">
              <th colspan="4" class="text-end">Total Deliver Qty</th>
              <th class="text-end">{{ totalDeliverQty | number:'1.0-2' }}</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- EDIT MODE: existing lines -->
    <div class="mt-4" *ngIf="isEdit">
      <h6 class="mb-2">Existing DO Lines</h6>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th style="width:120px">UOM</th>
              <th class="text-end" style="width:120px">Qty</th>
              <!-- <th style="width:180px">Pick From</th>
              <th style="width:120px">Supplier</th> -->
              <th style="width:260px">Notes</th>
              <th style="width:120px">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let l of editLines; trackBy: trackByLineId">
              <td>{{ l.itemName || ('#' + (l.itemId || '')) }}</td>
              <td>{{ uomLabel(l.uom ?? l.uomId) }}</td>
              <td class="text-end">{{ l.qty | number:'1.0-2' }}</td>
              <!-- <td class="small text-muted">WH: {{ l.warehouseId || '-' }} / Bin: {{ l.binId || '-' }}</td>
              <td class="text-muted small">{{ l.supplierId || '-' }}</td> -->
              <td>{{ l.notes || '-' }}</td>
              <td>
                <button class="btn btn-outline-danger btn-sm"
                        (click)="removeEditLine(l.id)" [disabled]="isPosted">
                  Remove
                </button>
              </td>
            </tr>
            <tr *ngIf="!editLines?.length">
              <td colspan="7" class="text-center text-muted">No lines on this DO</td>
            </tr>
          </tbody>
          <tfoot *ngIf="editLines?.length">
            <tr class="table-light">
              <th colspan="2" class="text-end">TOTAL</th>
              <th class="text-end">{{ totalEditQty | number:'1.0-2' }}</th>
              <th colspan="4"></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- EDIT MODE: Re-Delivery (from Sales Order) -->
    <div class="mt-4" *ngIf="isEdit && redeliveryRows?.length">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="m-0">Re-Delivery (from Sales Order)</h6>
        <!-- ENABLE even if posted -->
        <button class="btn btn-outline-primary btn-sm"
                (click)="addSelectedRedeliveries()"
                [disabled]="totalDeliverMore <= 0">
          Add Selected
        </button>
      </div>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th style="width:120px">UOM</th>
              <th class="text-end" style="width:120px">Ordered</th>
              <th class="text-end" style="width:140px">On This DO</th>
              <th class="text-end" style="width:120px">Pending</th>
              <th class="text-end" style="width:160px">Deliver More</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of redeliveryRows; trackBy: trackBySoLineId">
              <td>{{ r.itemName || ('#' + (r.itemId || '')) }}</td>
              <td>{{ uomLabel(r.uom) }}</td>
              <td class="text-end">{{ r.ordered | number:'1.0-2' }}</td>
              <td class="text-end">{{ r.deliveredOnThisDo | number:'1.0-2' }}</td>
              <td class="text-end">{{ r.pending | number:'1.0-2' }}</td>
              <td class="text-end">
                <!-- ENABLE even if posted -->
                <input type="number" class="form-control text-end"
                       [(ngModel)]="r.deliverMore"
                       [min]="0" [max]="r.pending"
                       (ngModelChange)="clampDeliverMore(r)">
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="table-light">
              <th colspan="4" class="text-end">Totals</th>
              <th class="text-end">{{ totalPending | number:'1.0-2' }}</th>
              <th class="text-end">{{ totalDeliverMore | number:'1.0-2' }}</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>
