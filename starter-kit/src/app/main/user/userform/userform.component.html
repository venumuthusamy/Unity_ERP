<div class="card shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <h4 class="mb-0" style="color:#2E5F73;font-weight:700;">
        {{ isEdit ? 'Edit User' : 'New User' }}
      </h4>
      <small class="text-muted">Administration → Users</small>
    </div>

    <button class="btn btn-outline-secondary btn-sm" (click)="cancel()">
      <i class="fas fa-arrow-left me-50"></i> Back
    </button>
  </div>

  <div class="card-body">
    <form [formGroup]="form">
      <div class="row g-2">

        <!-- USERNAME -->
        <div class="col-md-4">
          <label class="form-label small">Username</label>
          <input class="form-control" formControlName="username" />
        </div>

        <!-- EMAIL -->
        <div class="col-md-4">
          <label class="form-label small">Email</label>
          <input class="form-control"
                 formControlName="email"
                 [class.is-invalid]="form.get('email')?.touched && form.get('email')?.invalid" />
          <div class="invalid-feedback">
            Enter a valid email address
          </div>
        </div>

        <!-- PASSWORD -->
        <div class="col-md-4">
          <label class="form-label small d-flex justify-content-between align-items-center">
            <span>Password</span>
            <button *ngIf="isEdit"
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    (click)="togglePasswordEdit()">
              {{ canEditPassword ? 'Cancel' : 'Change Password' }}
            </button>
          </label>

          <input type="password"
                 class="form-control"
                 formControlName="password"
                 [readonly]="isEdit && !canEditPassword"
                 [class.is-invalid]="canEditPassword && form.get('password')?.touched && form.get('password')?.invalid" />

          <small *ngIf="isEdit && !canEditPassword" class="text-muted">
            Password hidden. Click <b>Change Password</b> to update.
          </small>

          <div class="invalid-feedback">
            Password must be 8+ chars with uppercase, lowercase, number & special char
          </div>
        </div>

        <!-- ROLES -->
        <div class="col-md-6 mt-1">
          <label class="form-label small">Roles (Approval Levels)</label>

          <ng-select
            [items]="roles"
            bindLabel="name"
            bindValue="id"
            [multiple]="true"
            [closeOnSelect]="false"
            placeholder="Select roles"
            formControlName="approvalLevelIds">

            <ng-template ng-label-tmp let-item="item" let-clear="clear">
              <span class="role-chip">
                {{ item.name }}
                <span class="role-chip-x" (click)="clear(item)">×</span>
              </span>
            </ng-template>

            <ng-template ng-option-tmp let-item="item">
              <div class="fw-semibold">{{ item.name }}</div>
              <small class="text-muted">{{ item.description }}</small>
            </ng-template>
          </ng-select>
        </div>

      </div>
    </form>
  </div>

  <div class="card-footer text-end">
    <button class="btn btn-outline-secondary me-1" (click)="cancel()">Cancel</button>
    <button class="btn btn-brand"
            style="background:#2E5F73;color:#fff;"
            (click)="save()"
            [disabled]="form.invalid">
      Save
    </button>
  </div>
</div>
