<button (click)="goToSupplierInvoice()"
  class="btn mb-2 position-relative d-flex align-items-center justify-content-center"
  style="background-color:#2E5F73; color:white; padding-left:2.25rem;">
  <i class="fas fa-arrow-left position-absolute"
     style="left:0.75rem; top:50%; transform:translateY(-50%);"
     aria-hidden="true"></i>
  <span>Go to Supplier Invoice list</span>
</button>

<form class="ui-compact" [formGroup]="form">
  <div class="max-w-[1120px] mx-auto">
    <div class="bg-white rounded-2xl shadow p-2 border border-gray-100">

      <!-- Title + 3-way match pill -->
      <div class="flex items-center justify-between">
        <h4 class="card-text pin-title">Supplier Invoice (PIN)</h4>
        <span
          class="px-2 py-0.5 text-[11px] rounded-full bg-amber-50 text-amber-800 border border-amber-200 whitespace-nowrap">
          3-way match: PO · GRN · PIN
        </span>
      </div>

      <!-- Header fields -->
      <div class="grid grid-cols-1 md:grid-cols-5 gap-2 mt-2">

        <!-- GRN combobox -->
        <div class="relative grn-combobox">
          <label class="text-[11px] font-medium text-gray-600 block">GRN #</label>
          <div class="relative">
            <input type="text"
                   [value]="grnSearch"
                   (input)="onGrnSearch($event)"
                   (focus)="onGrnFocus()"
                   placeholder="Search GRN…"
                   class="w-full rounded-lg border px-2.5 h-8 text-[13px] pr-7"
                   [attr.aria-autocomplete]="'list'"
                   [attr.aria-expanded]="grnOpen" />
            <button type="button"
                    class="absolute right-1 top-1/2 -translate-y-1/2 text-gray-500 text-[11px]"
                    (click)="grnOpen = !grnOpen"
                    aria-label="Toggle GRN list">▼</button>
          </div>

          <!-- actual form value -->
          <input type="hidden" formControlName="grnId" />
          <input type="hidden" formControlName="grnNo" />

          <!-- dropdown -->
          <ul *ngIf="grnOpen"
              class="absolute left-0 right-0 mt-1 max-h-48 overflow-auto bg-white border rounded-md shadow z-20">
            <li *ngFor="let g of grnFiltered; trackBy: trackByGrn"
                (click)="selectGrn(g)"
                class="px-3 py-2 cursor-pointer hover:bg-blue-50 text-[13px]">
              <span class="font-medium">{{ g.grnNo }}</span>
              <small class="text-gray-500 ml-1" *ngIf="g.poNo">· PO: {{ g.poNo }}</small>
              <small class="text-gray-400 ml-1" *ngIf="g.supplierName">· {{ g.supplierName }}</small>
            </li>
            <li *ngIf="!grnFiltered?.length"
                class="px-3 py-2 text-gray-400 text-[13px]">
              No results
            </li>
          </ul>
        </div>
<!-- Supplier Name (auto-filled from GRN) -->
<div>
  <label class="text-[11px] font-medium text-gray-600 block">Supplier</label>
  <input
    type="text"
    class="w-full rounded-lg border px-2.5 h-8 text-[13px] bg-gray-50"
    formControlName="supplierName"
    readonly />
</div>

        <!-- Invoice Date -->
        <div>
          <label class="text-[11px] font-medium text-gray-600 block">Invoice Date</label>
          <input type="date"
                 class="w-full rounded-lg border px-2.5 h-8 text-[13px]"
                 [min]="minDate"
                 formControlName="invoiceDate" />
        </div>

        <!-- Amount (grand total, read-only) -->
        <div>
          <label class="text-[11px] font-medium text-gray-600 block">Amount</label>
          <input type="number"
                 class="w-full rounded-lg border px-2.5 h-8 text-[13px]"
                 formControlName="amount"
                 [readonly]="true" />
        </div>

        <!-- Tax % -->
        <div>
          <label class="text-[11px] font-medium text-gray-600 block">Tax (%)</label>
          <input type="number"
                 class="w-full rounded-lg border px-2.5 h-8 text-[13px]"
                 formControlName="tax"
                 (input)="onTaxChange()" />
        </div>
      </div>

      <!-- Lines table -->
      <div class="rounded-xl border border-gray-200 mt-2">
      <!-- Header row -->
<div
  class="grid grid-cols-[1.4fr_2.4fr_1fr_0.7fr_0.9fr_0.9fr_1fr]
         text-[12px] font-medium
         bg-[#0e3a4c] text-white whitespace-nowrap rounded-t-xl">
  <div class="px-2.5 py-2">Item</div>
  <div class="px-2.5 py-2">Budget</div>
  <div class="px-2.5 py-2">Location</div>
  <div class="px-2.5 py-2">Qty</div>
  <div class="px-2.5 py-2">Unit Price</div>
  <div class="px-2.5 py-2">Discount %</div>
  <div class="px-2.5 py-2 text-right">Total</div>
</div>

<!-- Body -->
<div formArrayName="lines">
  <div *ngIf="lines.length === 0"
       class="text-center text-[12.5px] text-gray-400 py-3">
    No lines yet.
  </div>

  <div *ngFor="let row of lines.controls; let i = index; trackBy: trackByIndex"
       [formGroupName]="i"
       class="grid grid-cols-[1.4fr_2.4fr_1fr_0.7fr_0.9fr_0.9fr_1fr] items-center border-t">

    <!-- Item -->
    <div class="px-2.5 py-1.5">
      <input class="w-full rounded-lg border px-2.5 h-8 text-[13px]"
             formControlName="item" />
    </div>

    <!-- Budget -->
 <div class="px-2.5 py-1.5">
  <ng-select
    class="pin-budget-select w-full"
    [items]="parentHeadList"
    bindLabel="label"
    bindValue="value"
    [searchable]="true"
    [clearable]="false"
    placeholder="Search / choose Budget Line..."
    formControlName="budgetLineId"
    appendTo="body"
    dropdownPosition="bottom">

    <ng-template ng-option-tmp let-item="item">
      <div class="pin-budget-option" [title]="item.label">
        {{ item.label }}
      </div>
    </ng-template>
  </ng-select>
</div>

    <!-- Location -->
    <div class="px-2.5 py-1.5">
      <input class="w-full rounded-lg border px-2.5 h-8 text-[13px]"
             formControlName="location" />
    </div>

    <!-- Qty -->
    <div class="px-2.5 py-1.5">
      <input type="number"
             class="w-full rounded-lg border px-2.5 h-8 text-[13px]"
             formControlName="qty"
             (input)="onCellChange(i)" />
    </div>

    <!-- Unit Price -->
    <div class="px-2.5 py-1.5">
      <input type="number"
             class="w-full rounded-lg border px-2.5 h-8 text-[13px]"
             formControlName="unitPrice"
             (input)="onCellChange(i)" />
    </div>

    <!-- Discount % -->
    <div class="px-2.5 py-1.5">
      <input type="number"
             class="w-full rounded-lg border px-2.5 h-8 text-[13px]"
             formControlName="discountPct"
             (input)="onCellChange(i)" />
    </div>

    <!-- Line total -->
    <div class="px-2.5 py-1.5 text-right text-[13px]">
      {{ row.get('lineTotal')?.value || 0 | number:'1.2-2' }}
    </div>
  </div>
</div>


        <!-- Footer totals -->
        <div class="border-t px-3 py-2 bg-slate-50 text-[13px]">
          <div class="flex justify-end">
            <div class="w-64 space-y-1">
              <div class="flex justify-between">
                <span>Sub-total</span>
                <span>{{ subTotal | number:'1.2-2' }}</span>
              </div>
              <div class="flex justify-between">
                <span>Discount</span>
                <span>- {{ discountTotal | number:'1.2-2' }}</span>
              </div>
              <div class="flex justify-between">
                <span>Tax ({{ form.get('tax')?.value || 0 }}%)</span>
                <span>{{ taxAmount | number:'1.2-2' }}</span>
              </div>
              <div class="flex justify-between font-semibold border-t pt-1 mt-1">
                <span>Grand total</span>
                <span>{{ grandTotal | number:'1.2-2' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex justify-end gap-2 mt-2">
        <button class="px-3 h-8 rounded-lg text-[13px] font-medium text-white disabled:opacity-60"
                type="button"
                [style.backgroundColor]="'#0e3a4c'"
                [disabled]="form.invalid"
                (click)="save('HOLD')">
          Save
        </button>
      </div>
    </div>
  </div>
</form>

<style>
  .ui-compact label {
    margin-bottom: 2px !important;
  }

  .ui-compact input[type="text"],
  .ui-compact input[type="number"],
  .ui-compact input[type="date"] {
    line-height: 1.25rem;
  }

  .ui-compact th {
    white-space: nowrap;
  }

  .ui-compact .grn-combobox ul {
    overscroll-behavior: contain;
  }
</style>
