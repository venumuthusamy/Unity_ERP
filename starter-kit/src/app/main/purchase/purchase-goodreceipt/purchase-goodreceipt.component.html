<!-- ========== ENTRY FORM (CREATE MODE ONLY) ========== -->
<div *ngIf="!isEditMode && !showSummary">
  <button class="btn mb-1 mt-1" style="background-color: #2E5F73; color: white;" (click)="goToDebitNoteList()">
     <i class="fa fa-arrow-left text-sm text-[14px]"></i>
    Go to GRN list
  </button>

  <div class="ui-compact mb-8">
    <div class="bg-white rounded-[28px] shadow-sm border border-gray-200 p-5 md:p-6">
      <!-- Title -->
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-xl font-semibold text-gray-800" style="font-size:1.25rem;font-weight:600;color:#2E5F73">Goods Receipt (GRN)</h2>

        <!-- Compact Save GRN button -->
    <button
  type="button"
  class="flex items-center gap-2 h-9 px-4 rounded-xl text-sm font-semibold text-white
         disabled:opacity-60 disabled:cursor-not-allowed transition"
  (click)="saveGRN()"
  (mouseenter)="hover = true"
  (mouseleave)="hover = false"
  [style.backgroundColor]="hover ? '#092f3f' : '#2E5F73'"
  [disabled]="isPostInventoryDisabled"
>
  <i *ngIf="!editingGrnId" class="fa fa-save text-[14px]"></i>
  <i *ngIf="editingGrnId" class="fa fa-edit text-[14px]"></i>
  <span>{{ editingGrnId ? 'Update GRN' : 'Save GRN' }}</span>
</button>

      </div>

      <!-- Header Inputs -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
        <!-- From PO -->
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">From PO</label>
          <select
            [(ngModel)]="selectedPO"
            (ngModelChange)="onPOChange($event)"
            class="w-full rounded-2xl border border-gray-200 px-3.5 py-2.5 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/20 focus:border-[#0e3a4c]"
          >
            <option [ngValue]="null" disabled>Select PO</option>
            <ng-container *ngFor="let po of purchaseOrder">
              <option [ngValue]="po.id">{{ po.purchaseOrderNo }}</option>
            </ng-container>
          </select>
        </div>

        <!-- Receipt Date -->
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">Receipt Date</label>
          <input
            type="date"
            [(ngModel)]="receiptDate"
             [min]="minDate"
            class="w-full rounded-2xl border border-gray-200 px-3.5 py-2.5 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/20 focus:border-[#0e3a4c]"
          />
        </div>

        <!-- Over-receipt Tolerance -->
<div>
  <label class="block text-xs font-medium text-gray-600 mb-1">Over-receipt Tolerance (%)</label>
  <input
    type="number"
    min="0"
    max="5"
    placeholder="0"
    [(ngModel)]="overReceiptTolerance"
    (keypress)="allowOnlyNumbers($event)"
    class="w-full rounded-2xl border border-gray-200 px-3.5 py-2.5 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/20 focus:border-[#0e3a4c]"
  />
</div>

      </div>

      <!-- Lines Table (Create form) -->
<div class="overflow-x-auto ring-1 ring-gray-300">
  <table class="w-full min-w-[1500px] text-sm border border-gray-400 border-collapse">
   <thead style="background-color: #2E5F73;" class="text-white">
  <tr>
    <th class="px-3 py-3 font-medium text-left border border-gray-400 first:rounded-tl-none last:rounded-tr-none">
      Item / Product
    </th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">Supplier Name</th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">Frozen/Chilled/Dry</th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">Surface Temp</th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">Expiry</th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">No of pest / Sign</th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">Dry / Spillage</th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">Odor</th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">Plate Number</th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">Defective Labels</th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">Damaged Package</th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">Time</th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">Initial</th>
    <th class="px-3 py-3 font-medium text-left border border-gray-400">Remarks</th>
  </tr>
</thead>

          <tbody class="bg-white">
            <tr *ngFor="let r of grnRows; let i = index; trackBy: trackByIndex">
              <!-- Item + code -->
              <td class="px-3 py-3 border border-gray-300">
                <div class="w-52">
                  <input [value]="r.itemText || ''" readonly
                         class="w-full rounded-2xl border border-gray-200 px-3 py-2 bg-gray-50 text-gray-800" />
                </div>
              </td>

              <!-- Supplier -->
              <td class="px-3 py-3 border border-gray-300">
                <input [value]="r.supplierName || ''" readonly
                       class="w-52 rounded-2xl border border-gray-200 px-3 py-2 bg-gray-50 text-gray-800" />
              </td>

              <!-- Storage type -->
              <td class="px-3 py-3 border border-gray-300">
                <select [(ngModel)]="r.storageType"
                        class="w-40 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]">
                  <option value="">Select</option>
                  <option value="Frozen">Frozen</option>
                  <option value="Chilled">Chilled</option>
                  <option value="Dry">Dry</option>
                </select>
              </td>

              <!-- Surface Temp -->
              <td class="px-3 py-3 border border-gray-300">
                <input [(ngModel)]="r.surfaceTemp" placeholder="Â°C"
                       class="w-28 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]" />
              </td>

              <!-- Expiry -->
              <td class="px-3 py-3 border border-gray-300">
                <input type="date"  [min]="minDate" [(ngModel)]="r.expiry"
                       class="w-40 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]" />
              </td>

              <!-- Pest Sign -->
              <td class="px-3 py-3 border border-gray-300">
                <select [(ngModel)]="r.pestSign"
                        class="w-28 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]">
                  <option value="">Select</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>

              <!-- Dry/Spillage -->
              <td class="px-3 py-3 border border-gray-300">
                <select [(ngModel)]="r.drySpillage"
                        class="w-28 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]">
                  <option value="">Select</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>

              <!-- Odor -->
              <td class="px-3 py-3 border border-gray-300">
                <select [(ngModel)]="r.odor"
                        class="w-28 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]">
                  <option value="">Select</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>

              <!-- Plate Number -->
              <td class="px-3 py-3 border border-gray-300">
                <input [(ngModel)]="r.plateNumber"
                       class="w-36 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]" />
              </td>

              <!-- Defect Labels -->
              <td class="px-3 py-3 border border-gray-300">
                <select [(ngModel)]="r.defectLabels"
                        class="w-32 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]">
                  <option value="">Select</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>

              <!-- Damaged Package -->
              <td class="px-3 py-3 border border-gray-300">
                <select [(ngModel)]="r.damagedPackage"
                        class="w-32 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]">
                  <option value="">Select</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </td>

              <!-- Time -->
              <td class="px-3 py-3 border border-gray-300">
                <input type="time" [(ngModel)]="r.time"
                       class="w-32 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]" />
              </td>

              <!-- Initial (image/signature) -->
              <td class="px-3 py-3 border border-gray-300">
                <button type="button" (click)="openInitialModal(r, i)"
                        class="inline-flex items-center justify-center h-10 w-24 rounded-2xl border border-gray-200 hover:bg-gray-50">
                  <img *ngIf="r.initial" [src]="r.initial" alt="Initial" class="h-8 w-8 object-contain rounded" />
                  <span *ngIf="!r.initial" class="text-gray-400">Initial</span>
                </button>
              </td>

              <!-- Remarks -->
              <td class="px-3 py-3 border border-gray-300">
                <input [(ngModel)]="r.remarks"
                       class="w-56 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>


    </div>
  </div>
</div>

<!-- ========== CREATE MODE: READ-ONLY GENERATED SUMMARY AFTER SAVE ========== -->
<div *ngIf="!isEditMode && showSummary && generatedGRN" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 md:p-6">
  <div class="flex items-center justify-between mb-4">
    <h3  class="" style="font-size:1.25rem;font-weight:600;color:#2E5F73">Generated GRN Summary</h3>
    
    <button class="btn" style="background-color:#2E5F73;color:#fff" (click)="goToDebitNoteList()">Go to GRN list</button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <div><span class="font-semibold text-gray-600">GRN No:</span> {{ generatedGRN.grnNo }}</div>
    <div><span class="font-semibold text-gray-600">PO No:</span> {{ generatedGRN.poNo || generatedGRN.poid }}</div>
  </div>

  <div class="overflow-x-auto rounded-xl border border-gray-300">
    <table class="w-full min-w-[1300px] text-sm border border-gray-300 rounded-xl overflow-hidden">
      <thead  style="background-color: #2E5F73;" class="text-white">
        <tr>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Item Code</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Supplier</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Storage Type</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Surface Temp</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Expiry</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Pest Sign</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Dry / Spillage</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Odor</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Plate #</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Defect Labels</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Damaged Pkg</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Time</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Initial</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Remarks</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Status</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Actions</th>
        </tr>
      </thead>

      <tbody class="bg-white divide-y divide-gray-200">
        <tr *ngFor="let row of generatedGRN.grnJson; let i = index">
          <td class="px-4 py-2 border border-gray-200">{{ row.itemCode || row.item }}</td>
          <td class="px-4 py-2 border border-gray-200">{{ row.supplierName }}</td>
          <td class="px-4 py-2 border border-gray-200">{{ row.storageType }}</td>
          <td class="px-4 py-2 border border-gray-200">{{ row.surfaceTemp }}</td>
          <td class="px-4 py-2 border border-gray-200">{{ row.expiry }}</td>
          <td class="px-4 py-2 border border-gray-200">{{ row.pestSign }}</td>
          <td class="px-4 py-2 border border-gray-200">{{ row.drySpillage }}</td>
          <td class="px-4 py-2 border border-gray-200">{{ row.odor }}</td>
          <td class="px-4 py-2 border border-gray-200">{{ row.plateNumber }}</td>
          <td class="px-4 py-2 border border-gray-200">{{ row.defectLabels }}</td>
          <td class="px-4 py-2 border border-gray-200">{{ row.damagedPackage }}</td>
          <td class="px-4 py-2 border border-gray-200">{{ row.time }}</td>
          <td class="px-4 py-2 border border-gray-200">
            <img *ngIf="row.initial" [src]="row.initial" class="h-8 w-8 object-contain rounded cursor-pointer border border-gray-300"
                 (click)="openImage(row.initial)" />
          </td>
          <td class="px-4 py-2 border border-gray-200">{{ row.remarks }}</td>
          <td class="px-4 py-2 border border-gray-200">
            <span class="px-2 py-1 rounded text-xs font-semibold"
                  [ngClass]="{
                    'bg-red-100 text-red-800': row.isFlagIssue,
                    'bg-green-100 text-green-800': !row.isFlagIssue && row.isPostInventory
                  }">
              {{ row.isFlagIssue ? 'Flagged' : (row.isPostInventory ? 'Posted' : '') }}
            </span>
          </td>
          <td class="px-4 py-2">
            <div class="flex flex-col sm:flex-row items-center justify-end gap-2">
              <button type="button"
                      class="inline-flex items-center justify-center gap-2 px-3.5 py-1.5 rounded-lg text-xs font-semibold text-white bg-amber-600 hover:bg-amber-700 shadow-sm"
                      (click)="onFlagIssuesRow(row, i)">
                <i class="fa fa-flag text-[11px] opacity-90"></i> Flag Issues
              </button>
<button 
  type="button"
  class="inline-flex items-center justify-center gap-2 px-3.5 py-1.5 rounded-lg text-xs font-semibold text-white bg-[#2E5F73] hover:bg-[#264e60] shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
  (click)="onPostInventoryRow(row, i)"
  [disabled]="isPostInventoryDisabled || row.isPostInventory"
>
  <i class="fa fa-box text-[11px] opacity-90"></i>
  Post Inventory
</button>

            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ========== EDIT MODE: EDITABLE GRN SUMMARY ========== -->
<div *ngIf="isEditMode && generatedGRN" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 md:p-6">
  <div class="flex items-center justify-between mb-4">
     <h3  class="" style="font-size:1.25rem;font-weight:600;color:#2E5F73">Edit GRN</h3>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <div><span class="font-semibold text-gray-600">GRN No:</span> {{ generatedGRN.grnNo }}</div>
    <div><span class="font-semibold text-gray-600">PO No:</span> {{ generatedGRN.poNo || generatedGRN.poid }}</div>
    <div *ngIf="generatedGRN.flagIssuesId"><span class="font-semibold text-gray-600">Flag Issue ID:</span> {{ generatedGRN.flagIssuesId }}</div>
  </div>

  <div class="overflow-x-auto rounded-xl border border-gray-300">
    <table class="w-full min-w-[1300px] text-sm border border-gray-300 rounded-xl overflow-hidden">
      <thead  style="background-color: #2E5F73;" class="text-white">
        <tr>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Item Code</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Supplier</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Storage Type</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Surface Temp</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Expiry</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Pest Sign</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Dry / Spillage</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Odor</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Plate #</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Defect Labels</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Damaged Pkg</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Time</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Initial</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Remarks</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Status</th>
          <th class="px-4 py-2 text-left font-medium border border-gray-300">Actions</th>
        </tr>
      </thead>

      <tbody class="bg-white divide-y divide-gray-200">
        <ng-container *ngFor="let row of generatedGRN.grnJson; let i = index">
          <tr *ngIf="!row.isPostInventory" class="hover:bg-gray-50 transition-colors">
            <td class="px-4 py-2 border border-gray-200">{{ row.itemCode || row.item }}</td>

            <td class="px-4 py-2 border border-gray-200">
              <input [(ngModel)]="row.supplierName" class="w-48 rounded-xl border px-2 py-1 text-sm" />
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <select [(ngModel)]="row.storageType" class="w-36 rounded-xl border px-2 py-1 text-sm">
                <option value="">Select</option>
                <option>Frozen</option>
                <option>Chilled</option>
                <option>Dry</option>
              </select>
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <input [(ngModel)]="row.surfaceTemp" class="w-20 rounded-xl border px-2 py-1 text-sm" />
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <input type="date" [(ngModel)]="row.expiry" class="w-40 rounded-xl border px-2 py-1 text-sm" />
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <select [(ngModel)]="row.pestSign" class="w-28 rounded-xl border px-2 py-1 text-sm">
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <select [(ngModel)]="row.drySpillage" class="w-28 rounded-xl border px-2 py-1 text-sm">
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <select [(ngModel)]="row.odor" class="w-28 rounded-xl border px-2 py-1 text-sm">
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <input [(ngModel)]="row.plateNumber" class="w-28 rounded-xl border px-2 py-1 text-sm" />
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <select [(ngModel)]="row.defectLabels" class="w-28 rounded-xl border px-2 py-1 text-sm">
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <select [(ngModel)]="row.damagedPackage" class="w-28 rounded-xl border px-2 py-1 text-sm">
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <input type="time" [(ngModel)]="row.time" class="w-28 rounded-xl border px-2 py-1 text-sm" />
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <img *ngIf="row.initial" [src]="row.initial" alt="initial"
                   class="h-8 w-8 object-contain rounded cursor-pointer border border-gray-300"
                   (click)="openImage(row.initial)" />
              <button *ngIf="!row.initial" type="button" (click)="openInitialModal(row, i)"
                      class="inline-flex items-center justify-center h-8 px-2 rounded-xl border">Add</button>
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <input [(ngModel)]="row.remarks" class="w-56 rounded-xl border px-2 py-1 text-sm" />
            </td>

            <td class="px-4 py-2 border border-gray-200">
              <span class="px-2 py-1 rounded text-xs font-semibold"
                    [ngClass]="{
                      'bg-red-100 text-red-800': row.isFlagIssue,
                      'bg-green-100 text-green-800': !row.isFlagIssue && row.isPostInventory
                    }">
                {{ row.isFlagIssue ? 'Flagged' : (row.isPostInventory ? 'Posted' : '') }}
              </span>
            </td>

            <td class="px-4 py-2">
              <div class="flex flex-col sm:flex-row items-center justify-end gap-2">
                <button type="button"
                        class="inline-flex items-center justify-center gap-2 px-3.5 py-1.5 rounded-lg text-xs font-semibold text-white bg-amber-600 hover:bg-amber-700 shadow-sm"
                        (click)="onFlagIssuesRow(row, i)">
                  <i class="fa fa-flag text-[11px] opacity-90"></i> Flag Issues
                </button>

                <button type="button"
                        class="inline-flex items-center justify-center gap-2 px-3.5 py-1.5 rounded-lg text-xs font-semibold text-white bg-emerald-700 hover:bg-emerald-800 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
                        (click)="onPostInventoryRow(row, i)"
                        [disabled]="isPostInventoryDisabled">
                  <i class="fa fa-box text-[11px] opacity-90"></i> Post Inventory
                </button>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>
</div>


<!-- ========== INITIAL / SIGNATURE MODAL (reuse) ========== -->
<!-- ========== INITIAL / SIGNATURE MODAL (compact) ========== -->
<div *ngIf="showInitialModal" class="fixed inset-0 z-[1000] flex items-center justify-center" (keydown.escape)="closeInitialModal()">
  <!-- backdrop -->
  <div class="absolute inset-0 bg-black/40" (click)="closeInitialModal()"></div>

  <!-- modal -->
  <div
    class="relative bg-white rounded-2xl w-[92vw] max-w-[560px] shadow-xl ring-1 ring-black/5"
    role="dialog"
    aria-modal="true"
  >
    <!-- close -->
    <button
      type="button"
      class="absolute top-2.5 right-2.5 h-8 w-8 grid place-items-center rounded-full hover:bg-gray-100"
      (click)="closeInitialModal()"
      aria-label="Close"
      title="Close"
    >âœ•</button>

    <!-- header / tabs -->
    <div class="px-4 pt-4">
      <div class="flex items-center justify-center gap-6 border-b border-gray-200">
        <button
          type="button"
          class="pb-2 text-sm font-semibold transition"
          [class.text-[#0e3a4c]]="activeTab === 'image'"
          [class.border-b-2]="activeTab === 'image'"
          [class.border-[#0e3a4c]]="activeTab === 'image'"
          (click)="switchTab('image')"
        >
          Image
        </button>

        <button
          type="button"
          class="pb-2 text-sm font-semibold transition"
          [class.text-[#0e3a4c]]="activeTab === 'signature'"
          [class.border-b-2]="activeTab === 'signature'"
          [class.border-[#0e3a4c]]="activeTab === 'signature'"
          (click)="switchTab('signature')"
        >
          Signature
        </button>
      </div>
    </div>

    <div class="px-4 pb-4 pt-4">
      <!-- IMAGE TAB -->
      <div *ngIf="activeTab === 'image'">
        <div
          class="relative w-full border-2 border-dashed rounded-xl p-4 text-center cursor-pointer transition min-h-[11rem]"
          [ngClass]="isDragOver ? 'border-[#0e3a4c]' : 'border-gray-300'"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          (click)="fileInput.click()"
        >
       <ng-container *ngIf="!uploadedImage; else previewTpl">
  <div class="flex flex-col items-center justify-center text-gray-500 h-full">
    <!-- Upload Icon -->
    <i data-feather="upload-cloud" class="w-6 h-6 mb-2"></i>
    
    <!-- Instruction Text -->
    <p class="text-sm font-medium text-gray-700">Drop files here or click to upload</p>
  </div>
</ng-container>


          <ng-template #previewTpl>
            <div class="flex items-center justify-center h-full">
              <img
                [src]="uploadedImage"
                alt="Preview"
                class="max-h-40 max-w-full object-contain rounded-lg shadow-sm"
                style="pointer-events: none;"
              />
            </div>
          </ng-template>

          <input #fileInput type="file" accept="image/*" class="hidden" (change)="onImageSelected($event)" />
        </div>

        <!-- actions -->
        <div class="flex items-center justify-center gap-2 mt-3 ui-compact">
          <button
            type="button"
            class="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold text-white hover:bg-[#1f4a5c] transition"
            style="background:#2E5F73"
            (click)="saveImage()"
          >
            <i class="fa fa-image text-[11px] opacity-90"></i>
            <span>Save Image</span>
          </button>

          <button
            type="button"
            class="flex items-center gap-1.5 px-3 py-1.5 rounded-full border text-xs font-semibold text-gray-700 hover:bg-gray-50 transition"
            (click)="clearImage()"
          >
            <i class="fa fa-times-circle text-[11px] opacity-90"></i>
            <span>Clear</span>
          </button>
        </div>
      </div>

      <!-- SIGNATURE TAB -->
      <div *ngIf="activeTab === 'signature'">
        <div class="border rounded-xl overflow-hidden mb-3">
          <!-- lowered height to 140px to reduce vertical footprint -->
          <canvas #signaturePad class="block" style="touch-action:none;width:100%;height:140px"></canvas>
        </div>

        <div class="flex items-center justify-center gap-2 ui-compact">
          <button
            type="button"
            class="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold text-white"
            style="background:#2E5F73"
            (click)="saveSignature()"
          >
            <i class="fa fa-check-circle text-[11px] opacity-90"></i>
            <span>Save Signature</span>
          </button>

          <button
            type="button"
            class="flex items-center gap-1.5 px-3 py-1.5 rounded-full border text-xs font-semibold text-gray-700 hover:bg-gray-50 transition"
            (click)="clearSignature()"
          >
            <i class="fa fa-times-circle text-[11px] opacity-90"></i>
            <span>Clear</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- ========== FLAG ISSUES MODAL (reuse) ========== -->
<div *ngIf="flagModal.open" 
     class="fixed inset-0 z-[1000] flex items-center justify-center px-4 md:px-0"
     (keydown.escape)="closeFlagIssuesModal()">

  <!-- Background Overlay -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" (click)="closeFlagIssuesModal()"></div>

  <!-- Modal Box -->
  <div class="relative bg-white rounded-xl w-full max-w-md shadow-2xl p-6 transition-all duration-300 ease-in-out">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold text-gray-800">ðŸš© Flag an Issue</h3>
      <button type="button"
              class="h-9 w-9 flex items-center justify-center rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition"
              (click)="closeFlagIssuesModal()" aria-label="Close">
        <span class="text-xl">Ã—</span>
      </button>
    </div>

    <!-- Body -->
   <div>
  <label class="block text-sm font-medium text-gray-700 mb-1">Select an Issue</label>
  <div class="relative">
    <select [(ngModel)]="selectedFlagIssueId"
            class="appearance-none w-full rounded-lg border border-gray-300 bg-white px-4 py-2 pr-10 text-sm shadow-sm
                   focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/30 focus:border-[#0e3a4c] cursor-pointer">
      <option [ngValue]="null" disabled>Select an issue</option>
      <option *ngFor="let fi of flagIssuesList" [ngValue]="fi.id">
        {{ fi.flagIssuesNames || fi.name || fi.flagIssueName || fi.FlagIssueName }}
      </option>
    </select>
    
    <!-- Dropdown Icon -->
    <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-400">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2"
           viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
      </svg>
    </div>
  </div>
</div>


    <!-- Footer Buttons -->
  <div class="mt-6 flex justify-center gap-3 ui-compact">
  <!-- Cancel Button -->
<button
    type="button"
    class="flex items-center gap-2 h-9 px-6 rounded-full text-sm font-medium text-white bg-[#e74c3c] hover:bg-[#c0392b] transition"
    (click)="closeFlagIssuesModal()"
  >
    <i data-feather="x-circle" class="w-4 h-4"></i>
    <span>Cancel</span>
  </button>


  <!-- Submit Button -->
  <button
    type="button"
    class="flex items-center gap-2 h-9 px-5 rounded-full text-sm font-medium text-white bg-[#2E5F73] hover:bg-[#264e60] transition"
    (click)="submitFlagIssue()"
  >
    <i class="fa fa-check-circle text-[13px]"></i>
    <span>Submit</span>
  </button>
</div>

  </div>
</div>


<!-- ========== LIGHTBOX FOR IMAGES ========== -->
<div *ngIf="imageViewer.open" class="fixed inset-0 z-[1100] flex items-center justify-center bg-black/70" (click)="closeImage()">
  <img *ngIf="imageViewer.src" [src]="imageViewer.src" class="max-h-[88vh] max-w-[88vw] object-contain" />
</div>
