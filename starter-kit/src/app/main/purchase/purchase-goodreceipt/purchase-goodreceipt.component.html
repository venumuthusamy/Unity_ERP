<div class="ui-compact">
  <!-- CARD / CONTAINER -->
  <div class="bg-white rounded-[28px] shadow-sm border border-gray-200 p-5 md:p-6">

    <!-- Title -->
    <div class="flex items-center justify-between mb-5">
      <h2 class="text-xl font-semibold text-gray-800">Goods Receipt (GRN)</h2>
      <button
        class="px-4 py-2 rounded-xl text-sm font-medium text-white"
        type="button"
        (click)="saveGRN()"
        (mouseenter)="hover = true"
        (mouseleave)="hover = false"
        [style.backgroundColor]="hover ? '#092f3f' : '#0e3a4c'"
        [disabled]="isPostInventoryDisabled"
      >
        Save GRN
      </button>
    </div>

    <!-- Header Inputs -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
      <!-- From PO -->
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">From PO</label>
        <select
          [(ngModel)]="selectedPO"
          (ngModelChange)="onPOChange($event)"
          class="w-full rounded-2xl border border-gray-200 px-3.5 py-2.5 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/20 focus:border-[#0e3a4c]"
        >
          <option [ngValue]="null" disabled>Select PO</option>
          <ng-container *ngFor="let po of purchaseOrder">
            <option [ngValue]="po.id">{{ po.purchaseOrderNo }}</option>
          </ng-container>
        </select>
      </div>

      <!-- Receipt Date -->
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Receipt Date</label>
        <input
          type="date"
          [(ngModel)]="receiptDate"
          class="w-full rounded-2xl border border-gray-200 px-3.5 py-2.5 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/20 focus:border-[#0e3a4c]"
        />
      </div>

      <!-- Over-receipt Tolerance -->
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Over-receipt Tolerance (%)</label>
        <input
          type="number"
          min="0"
          max="5"
          placeholder="0"
          [(ngModel)]="overReceiptTolerance"
          class="w-full rounded-2xl border border-gray-200 px-3.5 py-2.5 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/20 focus:border-[#0e3a4c]"
        />
      </div>
    </div>

    <!-- TABLE WRAPPER with FULL-WIDTH + OUTLINE -->
    <div class="overflow-x-auto rounded-2xl ring-1 ring-gray-300">
      <table class="w-full min-w-[1500px] text-sm border-separate [border-spacing:0]">
        <!-- HEADER -->
        <thead>
          <tr class="bg-[#0e3a4c] text-white">
            <th class="px-3 py-3 font-medium text-left border border-gray-300 first:rounded-tl-2xl">Item / Product</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300">Supplier Name</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300">Frozen/Chilled/Dry</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300">Surface Temp</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300">Expiry</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300">No of pest / Sign</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300">Dry / Spillage</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300">Odor</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300">Plate Number</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300">Defective Labels</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300">Damaged Package</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300">Time</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300">Initial</th>
            <th class="px-3 py-3 font-medium text-left border border-gray-300 last:rounded-tr-2xl">Remarks</th>
          </tr>
        </thead>

        <!-- BODY -->
        <tbody class="bg-white">
          <tr *ngFor="let r of grnRows; let i = index; trackBy: trackByIndex">
            <!-- Item (read-only; shows full text + small code) -->
            <td class="px-3 py-3 border border-gray-300">
              <div class="w-52">
                <input [value]="r.itemText || ''" readonly
                  class="w-full rounded-2xl border border-gray-200 px-3 py-2 bg-gray-50 text-gray-800" />
                <div *ngIf="r.itemCode" class="text-[11px] text-gray-500 mt-1">Code: {{ r.itemCode }}</div>
              </div>
            </td>

            <!-- Supplier (read-only; name) -->
            <td class="px-3 py-3 border border-gray-300">
              <input [value]="r.supplierName || ''" readonly
                class="w-52 rounded-2xl border border-gray-200 px-3 py-2 bg-gray-50 text-gray-800" />
            </td>

            <td class="px-3 py-3 border border-gray-300">
              <select [(ngModel)]="r.storageType"
                class="w-40 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]">
                <option value="">Select</option>
                <option value="Frozen">Frozen</option>
                <option value="Chilled">Chilled</option>
                <option value="Dry">Dry</option>
              </select>
            </td>

            <td class="px-3 py-3 border border-gray-300">
              <input [(ngModel)]="r.surfaceTemp" placeholder="Â°C"
                class="w-28 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]" />
            </td>

            <td class="px-3 py-3 border border-gray-300">
              <input type="date" [(ngModel)]="r.expiry"
                class="w-40 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]" />
            </td>

            <td class="px-3 py-3 border border-gray-300">
              <select [(ngModel)]="r.pestSign"
                class="w-28 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]">
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </td>

            <td class="px-3 py-3 border border-gray-300">
              <select [(ngModel)]="r.drySpillage"
                class="w-28 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]">
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </td>

            <td class="px-3 py-3 border border-gray-300">
              <select [(ngModel)]="r.odor"
                class="w-28 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]">
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </td>

            <td class="px-3 py-3 border border-gray-300">
              <input [(ngModel)]="r.plateNumber"
                class="w-36 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]" />
            </td>

            <td class="px-3 py-3 border border-gray-300">
              <select [(ngModel)]="r.defectLabels"
                class="w-32 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]">
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </td>

            <td class="px-3 py-3 border border-gray-300">
              <select [(ngModel)]="r.damagedPackage"
                class="w-32 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]">
                <option value="">Select</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </td>

            <td class="px-3 py-3 border border-gray-300">
              <input type="time" [(ngModel)]="r.time"
                class="w-32 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]" />
            </td>

            <td class="px-3 py-3 border border-gray-300">
              <button type="button" (click)="openInitialModal(r, i)"
                class="inline-flex items-center justify-center h-10 w-24 rounded-2xl border border-gray-200 hover:bg-gray-50">
                <img *ngIf="r.initial" [src]="r.initial" alt="Initial" class="h-8 w-8 object-contain rounded" />
                <span *ngIf="!r.initial" class="text-gray-400">Initial</span>
              </button>
            </td>

            <td class="px-3 py-3 border border-gray-300">
              <input [(ngModel)]="r.remarks"
                class="w-56 rounded-2xl border border-gray-200 px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#0e3a4c]/15 focus:border-[#0e3a4c]" />
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ========= INITIAL / SIGNATURE MODAL ========= -->
<div *ngIf="showInitialModal" class="fixed inset-0 z-[1000] flex items-center justify-center" (keydown.escape)="closeInitialModal()">
  <div class="absolute inset-0 bg-black/40" (click)="closeInitialModal()"></div>
  <div class="relative bg-white rounded-2xl w-[92vw] max-w-3xl shadow-lg" role="dialog" aria-modal="true">
    <button type="button" class="absolute top-3 right-3 h-9 w-9 grid place-items-center rounded-full hover:bg-gray-100"
      (click)="closeInitialModal()" aria-label="Close" title="Close">â</button>

    <!-- Tabs -->
    <div class="px-6 pt-6">
      <div class="flex gap-10 border-b">
        <button type="button" class="pb-2 text-base font-medium" [class.text-[#0e3a4c]]="activeTab === 'image'"
          [class.border-b-2]="activeTab === 'image'" [class.border-[#0e3a4c]]="activeTab === 'image'" (click)="switchTab('image')">
          Image
        </button>
        <button type="button" class="pb-2 text-base font-medium" [class.text-[#0e3a4c]]="activeTab === 'signature'"
          [class.border-b-2]="activeTab === 'signature'" [class.border-[#0e3a4c]]="activeTab === 'signature'"
          (click)="switchTab('signature')">
          Signature
        </button>
      </div>
    </div>

    <div class="px-6 pb-6 pt-5">
      <!-- IMAGE TAB -->
      <div *ngIf="activeTab === 'image'">
        <div class="w-full rounded-xl border border-gray-300 h-14 grid place-items-center text-gray-500 mb-5">
          <span *ngIf="!uploadedImage">No image selected</span>
          <img *ngIf="uploadedImage as img" [src]="img" class="max-h-12 object-contain" alt="Preview" />
        </div>

        <div class="mb-6">
          <input type="file" accept="image/*" (change)="onImageSelected($event)" />
        </div>

        <div class="flex items-center gap-3">
          <button type="button" class="px-5 py-2 rounded-full text-white" [style.backgroundColor]="'#0e3a4c'" (click)="saveImage()">
            Save Image
          </button>
          <button type="button" class="px-4 py-2 rounded-full border" (click)="clearImage()">Clear</button>
        </div>
      </div>

      <!-- SIGNATURE TAB -->
      <div *ngIf="activeTab === 'signature'">
        <div class="border rounded-xl overflow-hidden mb-4">
          <canvas #signaturePad class="block" style="touch-action: none; width: 100%; height: 180px"></canvas>
        </div>

        <div class="flex items-center gap-3">
          <button type="button" class="px-5 py-2 rounded-full text-white" [style.backgroundColor]="'#0e3a4c'" (click)="saveSignature()">
            Save Signature
          </button>
          <button type="button" class="px-4 py-2 rounded-full border" (click)="clearSignature()">Clear</button>
        </div>
      </div>
    </div>
  </div>
</div>
